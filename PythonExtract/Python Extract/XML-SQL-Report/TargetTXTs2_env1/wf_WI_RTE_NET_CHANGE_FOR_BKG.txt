ETL Name:	wf_WI_RTE_NET_CHANGE_FOR_BKG.XML


Session 1: 	s_m_WI_RTE_NET_CHANGE_FOR_BKG
Mapping 1: 	m_WI_RTE_NET_CHANGE_FOR_BKGm_WI_RTE_NET_CHANGE_FOR_BKG


Source1 Name : SQ_WI_BKG_TX_SQ_ID_RTE


Pre SQL : 
/* Commented as part of SQ Net change removal - Day1 FY21 */
/* Added as part of December RTNR release */
/*
DELETE FROM $$STGDB.WI_AR_SUMMARY_QUOTE_SMC ALL;

INSERT INTO $$STGDB.WI_AR_SUMMARY_QUOTE_SMC
SELECT  
     SALES_ORDER_LINE_KEY, 
     DV_EFFECTIVE_DTM, 
     CASE WHEN SO_CNT > 1 THEN 'MIX' 
	      ELSE SALES_MOTION_CD 
	  END SALES_MOTION_CD, 
     USER EDW_CREATE_USER, 
     CURRENT_TIMESTAMP(0) EDW_CREATE_DTM 
FROM ( SELECT SALES_ORDER_LINE_KEY, 
	  SALES_MOTION_CD,
	  MAX(DV_EFFECTIVE_DTM) OVER(PARTITION BY SALES_ORDER_LINE_KEY) AS DV_EFFECTIVE_DTM, 
	  COUNT(*) OVER(PARTITION BY SALES_ORDER_LINE_KEY) SO_CNT,
	  SUM(DV_ALLOCATION_PCT) OVER(PARTITION BY SALES_ORDER_LINE_KEY) DV_ALLOCATION_PCT
         FROM (
		 SELECT
		 SALES_ORDER_LINE_KEY,
			SALES_MOTION_CD,
			DV_EFFECTIVE_DTM,
			EDW_UPDATE_DTM,
			SUM(DV_ALLOCATION_PCT) OVER(PARTITION BY SALES_ORDER_LINE_KEY ) SUM_ALLOCATION_PCT,
			CAST( DV_ALLOCATION_PCT/SUM_ALLOCATION_PCT AS DECIMAL(18,6) ) AS DV_ALLOCATION_PCT /* Included inner query part to handle CS SQ scenario Sep 26 Q2FY20 Release 
			FROM
			$$SLSORDVWDB.MT_SUMMARY_QUOTE_SOL_ALLOC 
         WHERE DV_EXPIRATION_DTM = '3500-01-01 00:00:00'  
           AND SALES_ORDER_LINE_KEY IN ( SELECT SALES_ORDER_LINE_KEY  
                                            FROM $$SLSORDVWDB.MT_SUMMARY_QUOTE_SOL_ALLOC  
                                           WHERE EDW_UPDATE_DTM > ( SELECT LAST_EXTRACT_DATE FROM $$ETLVWDB.CTL_ETL_LAST_EXTRACT_DATES WHERE JOB_STREAM_ID = 'wf_WI_RTE_NET_CHANGE_FOR_BKG' AND TABLE_NAME = 'WI_AR_SUMMARY_QUOTE_SMC' ) 
                                         ) /* For identifying all open records for a particular allocation change
			  ) WI
) WI
WHERE ROUND(DV_ALLOCATION_PCT) = 1.00 
GROUP BY 1,2,3,4,5 ;

CALL COLLECT_STATS_WRAP('$$STGDB', 'WI_AR_SUMMARY_QUOTE_SMC', 'D') ;

UPDATE WI_AR
FROM $$STGDB.WI_AR_SALES_MOTION_CHANGE WI_AR, 
    ( SELECT SALES_ORDER_LINE_KEY, 
          SALES_MOTION_CD , 
          DV_EFFECTIVE_DTM 
    FROM $$STGDB.WI_AR_SUMMARY_QUOTE_SMC ) WI
SET SALES_MOTION_CD = WI.SALES_MOTION_CD ,
	SOURCE_COMMIT_TIME = WI.DV_EFFECTIVE_DTM,
    EDW_UPDATE_DTM = CURRENT_TIMESTAMP(0)              
 WHERE WI_AR.SALES_ORDER_LINE_KEY = WI.SALES_ORDER_LINE_KEY
   AND WI_AR.EDW_UPDATE_DTM < WI.DV_EFFECTIVE_DTM;
   
UPDATE EL 
FROM $$ETLVWDB.CTL_ETL_LAST_EXTRACT_DATES EL, 
	 ( SELECT MAX(EDW_UPDATE_DTM) MAX_UPD_DATE FROM $$SLSORDVWDB.MT_SUMMARY_QUOTE_SOL_ALLOC ) NSOL 
 SET LAST_EXTRACT_DATE = COALESCE(NSOL.MAX_UPD_DATE , EL.LAST_EXTRACT_DATE ) 
WHERE JOB_STREAM_ID = 'wf_WI_RTE_NET_CHANGE_FOR_BKG'  
AND TABLE_NAME = 'WI_AR_SUMMARY_QUOTE_SMC';
/* Added as part of December RTNR release

UPDATE WI 
FROM $$STGDB.WI_AR_SALES_MOTION_CHANGE WI , 
	( SELECT SALES_ORDER_LINE_KEY, 
			 SK_SALES_ORDER_LINE_ID_INT, 
			 SALES_MOTION_CD,
			 SOURCE_COMMIT_DTM 
	   FROM $$NRTNCRVWDB.N_SALES_ORDER_LINE_NRT_HIST_TV NSOL 
	   WHERE NSOL.END_TV_DTM = '3500-01-01 00:00:00'
AND NSOL.SS_CD <> 'OPL'
		 AND NSOL.SALES_ORDER_LINE_KEY NOT IN ( SELECT SALES_ORDER_LINE_KEY 
												FROM 
													( 
												SELECT
												 SALES_ORDER_LINE_KEY,
												 SALES_MOTION_CD,
												 DV_EFFECTIVE_DTM,
												 EDW_UPDATE_DTM,
												 SUM(DV_ALLOCATION_PCT) OVER(PARTITION BY SALES_ORDER_LINE_KEY ) SUM_ALLOCATION_PCT,
												 CAST( DV_ALLOCATION_PCT/SUM_ALLOCATION_PCT AS DECIMAL(18,6) ) AS DV_ALLOCATION_PCT /* Included inner query part to handle CS SQ scenario Sep 26 Q2FY20 Release 
					                            FROM
					                            $$SLSORDVWDB.MT_SUMMARY_QUOTE_SOL_ALLOC 
					                            WHERE DV_EXPIRATION_DTM = '3500-01-01 00:00:00' 
					                            ) WI 
												GROUP BY 1 HAVING ROUND(SUM(DV_ALLOCATION_PCT)) = 1.00)
												AND NSOL.EDW_UPDATE_DTM > CURRENT_DATE - 7
	) NSOL
SET SALES_MOTION_CD = NSOL.SALES_MOTION_CD , 
	SOURCE_COMMIT_TIME = NSOL.SOURCE_COMMIT_DTM,
	EDW_UPDATE_DTM = CURRENT_TIMESTAMP(0)
WHERE WI.SALES_ORDER_LINE_KEY = NSOL.SALES_ORDER_LINE_KEY
  AND WI.SALES_MOTION_CD <> NSOL.SALES_MOTION_CD ; 

INSERT INTO $$STGDB.WI_AR_SALES_MOTION_CHANGE  
 SELECT SALES_ORDER_LINE_KEY, 
		SK_SALES_ORDER_LINE_ID_INT, 
		SALES_MOTION_CD,
		SOURCE_COMMIT_DTM ,
		CURRENT_TIMESTAMP(0) AS EDW_CREATE_DTM, 
		CURRENT_TIMESTAMP(0) AS EDW_UPDATE_DTM
		FROM
		(
		SELECT
		SALES_ORDER_LINE_KEY, 
		SK_SALES_ORDER_LINE_ID_INT, 
		SALES_MOTION_CD,
		SOURCE_COMMIT_DTM 
		FROM $$NRTNCRVWDB.N_SALES_ORDER_LINE_NRT_HIST_TV NSOL 
		WHERE NSOL.END_TV_DTM = '3500-01-01 00:00:00' 
		AND NSOL.SS_CD <> 'OPL'
		AND NSOL.EDW_UPDATE_DTM > CURRENT_DATE - 7 
		AND NSOL.SALES_MOTION_CD <> 'UNKNOWN'
		UNION
		SELECT
		NSOL1.SALES_ORDER_LINE_KEY, 
		NSOL1.SK_SALES_ORDER_LINE_ID_INT, 
		NSOL1.SALES_MOTION_CD,
		NSOL1.SOURCE_COMMIT_DTM 
		FROM $$STGDB.WI_AR_SUMMARY_QUOTE_SMC SMC
		INNER JOIN $$NRTNCRVWDB.N_SALES_ORDER_LINE_NRT_HIST_TV NSOL1 
		ON SMC.SALES_ORDER_LINE_KEY = NSOL1.SALES_ORDER_LINE_KEY
		AND NSOL1.SS_CD <> 'OPL'
		AND NSOL1.END_TV_DTM = '3500-01-01 00:00:00' 
   ) WI
 WHERE NOT EXISTS ( SELECT 1 FROM $$STGDB.WI_AR_SALES_MOTION_CHANGE WI_AR 
                    WHERE WI_AR.SALES_ORDER_LINE_KEY = WI.SALES_ORDER_LINE_KEY ) ; 

COLLECT STATS ON $$STGDB.WI_AR_SALES_MOTION_CHANGE ;

*/


SQL Query : 
SELECT 
   DRVD.TRANSACTION_SEQUENCE_ID_INT AS BK_TRANSACTION_SEQ_ID_INT, 
  DRVD.SOURCE_SYSTEM_CODE AS BK_SS_CD , 
  DRVD.DV_TRANSACTION_SOURCE_CD      , 
  DRVD.DV_TRANSACTION_KEY,
  NRSCA.SCA_SOURCE_COMMIT_DTM ,
    CASE  WHEN ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  ) < (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100) 
   THEN NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT
   ELSE   NFISMN.BK_FISCAL_MONTH_NUMBER_INT
  END AS BK_FISCAL_MONTH_NUMBER_INT , 
  CASE  WHEN ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  ) < (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100)
   THEN NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT
   ELSE   NFISMN.BK_FISCAL_YEAR_NUMBER_INT
  END AS BK_FISCAL_YEAR_NUMBER_INT ,
  CASE  WHEN ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  ) < (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100)
   THEN (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100)
   ELSE   ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  )
  END AS DV_FISCAL_YEAR_MONTH_NUM_INT
 FROM 
 (SELECT LAST_EXTRACT_DATE FROM $$ETLVWDB.DW_JOB_STREAMS WHERE JOB_STREAM_ID ='wf_WI_RTE_NET_CHANGE_FOR_BKG') X,
   ( SELECT BK_FISCAL_MONTH_NUMBER_INT, BK_FISCAL_YEAR_NUMBER_INT
   FROM $$COMREFVWDB.N_FISCAL_MONTH 
   WHERE CURRENT_DATE-1 BETWEEN FISCAL_MONTH_START_DATE AND FISCAL_MONTH_END_DATE
  ) NFISMN_SYS ,
 $$FINLGLVWDB.N_DRVD_NCR_REV_TRX_FOR_BKG DRVD
 INNER JOIN $$COMREFVWDB.N_SOURCE_SYSTEM_CODES NSSC 
  ON (DRVD.SOURCE_SYSTEM_CODE  = NSSC.SOURCE_SYSTEM_CODE )
 INNER JOIN $$FINLGLVWDB.N_REVENUE_TRANSFER NRA
 ON(NRA.REVENUE_TRANSFER_KEY  =DRVD.REVENUE_TRANSFER_KEY)
 INNER JOIN $$SLSORDVWDB.N_SCA_FOR_RTE_TRX  NRSCA
  ON NRSCA.EP_TRANSACTION_ID_INT = NRA.EP_TRANSACTION_ID_INT   
 INNER JOIN $$ETLVWDB.SM_SCA_FOR_RTE_TRX SRSCA
 ON (SRSCA.SALES_CREDIT_ASSIGNMENT_KEY=NRSCA.SALES_CREDIT_ASSIGNMENT_KEY )
 INNER JOIN 
 ( SELECT BK_SALES_CREDIT_TYPE_CODE, SALES_CREDIT_TYPE_QUOTA_FLAG   QUOTA_FLAG
  FROM $$SLSORDVWDB.N_SALES_CREDIT_TYPE_TV  
  QUALIFY ROW_NUMBER () OVER (PARTITION BY BK_SALES_CREDIT_TYPE_CODE   ORDER BY END_TV_DATE DESC)=1
) NSCTT
  ON NRSCA.SALES_CREDIT_TYPE_CD = NSCTT.BK_SALES_CREDIT_TYPE_CODE 
 INNER JOIN $$COMREFVWDB.N_FISCAL_MONTH NFISMN  
  ON  NRSCA.SCA_SOURCE_COMMIT_DTM BETWEEN NFISMN.FISCAL_MONTH_START_DATE AND NFISMN.FISCAL_MONTH_END_DATE
 WHERE
  DRVD.SCA_SOURCE_TYPE_CD IN ('X','R')
  AND (DRVD.FORWARD_REVERSE_CODE   = 'F' OR DRVD.FORWARD_REVERSE_CODE   = 'FORWARD')  
  AND DRVD.LAST_RECORD_FLAG ='Y' 
   /* TO PULL INCREMENTALLY */ 
 /*AND NRA.TRANSACTION_SOURCE_CD = 'ERP': Q1FY17 commented as part of Q1FY18 XAAS SC*/
 AND NRSCA.EDW_UPDATE_DTM > X.LAST_EXTRACT_DATE
 QUALIFY RANK () OVER ( PARTITION BY DRVD.SOURCE_SYSTEM_CODE , DV_TRANSACTION_SOURCE_CD  , DV_TRANSACTION_KEY, NRSCA.EP_TRANSACTION_ID_INT ORDER BY NRSCA.SK_LINE_SEQ_ID_INT DESC)=1


Post SQL : 



Target1 Name : WI_BKG_TX_SQ_ID_RTE1


Pre SQL : 
DELETE FROM $$STGDB.WI_BKG_TX_SQ_ID_RTE;


Post SQL : 
COLLECT STATS ON $$STGDB.WI_BKG_TX_SQ_ID_RTE;


Source2 Name : SQ_WI_BKG_TX_SQ_ID_FORWARD


Pre SQL : 



SQL Query : 
SELECT    DRVD.TRANSACTION_SEQUENCE_ID_INT AS BK_TRANSACTION_SEQ_ID_INT,
       DRVD.SOURCE_SYSTEM_CODE AS BK_SS_CD ,    DRVD.DV_TRANSACTION_SOURCE_CD      ,
       DRVD.DV_TRANSACTION_KEY,   NULL OLD_DEFAULT_SC_FLG,          NRSCA.SK_LINE_SEQ_ID_INT,
        NRSCA.SCA_SOURCE_TYPE_CD,    NSCTT.QUOTA_FLAG,       NRSCA.SCA_SOURCE_COMMIT_DTM ,
      CASE 
     WHEN ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  ) < (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100)         THEN NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT        
     ELSE NFISMN.BK_FISCAL_MONTH_NUMBER_INT   
    END AS BK_FISCAL_MONTH_NUMBER_INT ,    
    CASE 
     WHEN ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  ) < (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100)       THEN NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT       
     ELSE NFISMN.BK_FISCAL_YEAR_NUMBER_INT   
    END AS BK_FISCAL_YEAR_NUMBER_INT ,   
    CASE 
     WHEN ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  ) < (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100)       THEN (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100)       
     ELSE ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  )   
    END AS DV_FISCAL_YEAR_MONTH_NUM_INT,    -999 AS EP_SK_SALES_CREDIT_TYPE_ID_INT,
               -999 AS EP_SK_SALESREP_ID_INT,   -999 AS  EP_SK_TERRITORY_ID_INT,
      NRSCA.SCA_SALES_COMMISSION_PCT,    NRSCA.SALES_CREDIT_TYPE_CD,
      NULL AS EVENT_TYPE,   NRSCA.SALES_REP_NUM  ,   NRSCA.SALES_TERRITORY_KEY   ,
    /*  Coalesce(SMC.SALES_MOTION_CD, 'UNKNOWN' ) */ /* Commented as part of SQ Net change removal - Day1 FY21 */
	'UNKNOWN' AS SALES_MOTION_CD	  
  FROM   (
   SELECT LAST_EXTRACT_DATE 
   FROM $$ETLVWDB.DW_JOB_STREAMS 
   WHERE JOB_STREAM_ID ='wf_WI_RTE_NET_CHANGE_FOR_BKG') X,    ( 
   SELECT BK_FISCAL_MONTH_NUMBER_INT, BK_FISCAL_YEAR_NUMBER_INT    
   FROM $$COMREFVWDB.N_FISCAL_MONTH     
   WHERE Current_Date-1 BETWEEN FISCAL_MONTH_START_DATE 
    AND FISCAL_MONTH_END_DATE   ) NFISMN_SYS ,  $$FINLGLVWDB.N_DRVD_NCR_REV_TRX_FOR_BKG DRVD  
  INNER JOIN $$COMREFVWDB.N_SOURCE_SYSTEM_CODES NSSC    
   ON (DRVD.SOURCE_SYSTEM_CODE  = NSSC.SOURCE_SYSTEM_CODE )  
  INNER JOIN $$FINLGLVWDB.N_REVENUE_TRANSFER NRA  
   ON(NRA.REVENUE_TRANSFER_KEY  =DRVD.REVENUE_TRANSFER_KEY)  
  INNER JOIN $$SLSORDVWDB.N_SCA_FOR_RTE_TRX  NRSCA   
   ON NRSCA.EP_TRANSACTION_ID_INT = NRA.EP_TRANSACTION_ID_INT     
  INNER JOIN $$ETLVWDB.SM_SCA_FOR_RTE_TRX SRSCA  
   ON (SRSCA.SALES_CREDIT_ASSIGNMENT_KEY=NRSCA.SALES_CREDIT_ASSIGNMENT_KEY )  
  INNER JOIN   ( 
   SELECT BK_SALES_CREDIT_TYPE_CODE, SALES_CREDIT_TYPE_QUOTA_FLAG   QUOTA_FLAG   
   FROM $$SLSORDVWDB.N_SALES_CREDIT_TYPE_TV     
   QUALIFY Row_Number () Over (
   PARTITION BY BK_SALES_CREDIT_TYPE_CODE   
   ORDER BY END_TV_DATE DESC)=1 ) NSCTT   
   ON NRSCA.SALES_CREDIT_TYPE_CD = NSCTT.BK_SALES_CREDIT_TYPE_CODE   
  INNER JOIN $$COMREFVWDB.N_FISCAL_MONTH NFISMN     
   ON  NRSCA.SCA_SOURCE_COMMIT_DTM BETWEEN NFISMN.FISCAL_MONTH_START_DATE 
   AND NFISMN.FISCAL_MONTH_END_DATE   
  /* LEFT JOIN $$STGDB.WI_AR_SALES_MOTION_CHANGE SMC     
   ON DRVD.DV_SALES_ORDER_LINE_KEY = SMC.SALES_ORDER_LINE_KEY */ /* Commented as part of SQ Net change removal - Day1 FY21 */
  WHERE   DRVD.SCA_SOURCE_TYPE_CD IN ('X','R')   
   AND (DRVD.FORWARD_REVERSE_CODE   = 'F' 
   OR DRVD.FORWARD_REVERSE_CODE   = 'FORWARD')     
   AND DRVD.LAST_RECORD_FLAG ='Y'          
   AND NRSCA.EDW_UPDATE_DTM > X.LAST_EXTRACT_DATE  
   AND DRVD.REVENUE_TRANSFER_KEY = -999
  QUALIFY Rank () Over ( 
  PARTITION BY DRVD.SOURCE_SYSTEM_CODE , DV_TRANSACTION_SOURCE_CD  ,
    DV_TRANSACTION_KEY, NRSCA.EP_TRANSACTION_ID_INT 
  ORDER BY TRANSACTION_SEQUENCE_ID_INT DESC)=1 
  
  UNION ALL
  
  SELECT    DRVD.TRANSACTION_SEQUENCE_ID_INT AS BK_TRANSACTION_SEQ_ID_INT,
       DRVD.SOURCE_SYSTEM_CODE AS BK_SS_CD ,    DRVD.DV_TRANSACTION_SOURCE_CD      ,
       DRVD.DV_TRANSACTION_KEY,   NULL OLD_DEFAULT_SC_FLG,          NRSCA.SK_LINE_SEQ_ID_INT,
        NRSCA.SCA_SOURCE_TYPE_CD,    NSCTT.QUOTA_FLAG,       NRSCA.SCA_SOURCE_COMMIT_DTM ,
      CASE 
     WHEN ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  ) < (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100)         THEN NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT        
     ELSE NFISMN.BK_FISCAL_MONTH_NUMBER_INT   
    END AS BK_FISCAL_MONTH_NUMBER_INT ,    
    CASE 
     WHEN ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  ) < (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100)       THEN NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT       
     ELSE NFISMN.BK_FISCAL_YEAR_NUMBER_INT   
    END AS BK_FISCAL_YEAR_NUMBER_INT ,   
    CASE 
     WHEN ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  ) < (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100)       THEN (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT *100)       
     ELSE ( NFISMN.BK_FISCAL_MONTH_NUMBER_INT+NFISMN.BK_FISCAL_YEAR_NUMBER_INT *100  )   
    END AS DV_FISCAL_YEAR_MONTH_NUM_INT,    -999 AS EP_SK_SALES_CREDIT_TYPE_ID_INT,
               -999 AS EP_SK_SALESREP_ID_INT,   -999 AS  EP_SK_TERRITORY_ID_INT,
      NRSCA.SCA_SALES_COMMISSION_PCT,    NRSCA.SALES_CREDIT_TYPE_CD,
      NULL AS EVENT_TYPE,   NRSCA.SALES_REP_NUM  ,   NRSCA.SALES_TERRITORY_KEY   ,
    /* Coalesce(SMC.SALES_MOTION_CD, 'UNKNOWN' ) */ /* Commented as part of SQ Net change removal - Day1 FY21 */
	  'UNKNOWN' AS SALES_MOTION_CD
  FROM   (
   SELECT LAST_EXTRACT_DATE 
   FROM $$ETLVWDB.DW_JOB_STREAMS 
   WHERE JOB_STREAM_ID ='wf_WI_RTE_NET_CHANGE_FOR_BKG'
   ) X,    ( 
   SELECT BK_FISCAL_MONTH_NUMBER_INT, BK_FISCAL_YEAR_NUMBER_INT    
   FROM $$COMREFVWDB.N_FISCAL_MONTH     
   WHERE Current_Date-1 BETWEEN FISCAL_MONTH_START_DATE 
    AND FISCAL_MONTH_END_DATE   ) NFISMN_SYS ,  $$FINLGLVWDB.N_DRVD_NCR_REV_TRX_FOR_BKG DRVD  
  INNER JOIN $$COMREFVWDB.N_SOURCE_SYSTEM_CODES NSSC    
   ON (DRVD.SOURCE_SYSTEM_CODE  = NSSC.SOURCE_SYSTEM_CODE )  
  INNER JOIN $$FINLGLVWDB.N_REVENUE_TRANSFER NRA  
   ON(NRA.REVENUE_TRANSFER_KEY  =DRVD.REVENUE_TRANSFER_KEY)  
  INNER JOIN $$SLSORDVWDB.N_SCA_FOR_RTE_TRX  NRSCA   
   ON NRSCA.EP_TRANSACTION_ID_INT = NRA.EP_TRANSACTION_ID_INT     
  INNER JOIN $$ETLVWDB.SM_SCA_FOR_RTE_TRX SRSCA  
   ON (SRSCA.SALES_CREDIT_ASSIGNMENT_KEY=NRSCA.SALES_CREDIT_ASSIGNMENT_KEY )  
  INNER JOIN   ( 
   SELECT BK_SALES_CREDIT_TYPE_CODE, SALES_CREDIT_TYPE_QUOTA_FLAG   QUOTA_FLAG   
   FROM $$SLSORDVWDB.N_SALES_CREDIT_TYPE_TV     
   QUALIFY Row_Number () Over (
   PARTITION BY BK_SALES_CREDIT_TYPE_CODE   
   ORDER BY END_TV_DATE DESC)=1 ) NSCTT   
   ON NRSCA.SALES_CREDIT_TYPE_CD = NSCTT.BK_SALES_CREDIT_TYPE_CODE   
  INNER JOIN $$COMREFVWDB.N_FISCAL_MONTH NFISMN     
   ON  NRSCA.SCA_SOURCE_COMMIT_DTM BETWEEN NFISMN.FISCAL_MONTH_START_DATE 
   AND NFISMN.FISCAL_MONTH_END_DATE   
  /* LEFT JOIN $$STGDB.WI_AR_SALES_MOTION_CHANGE SMC     
   ON DRVD.DV_SALES_ORDER_LINE_KEY = SMC.SALES_ORDER_LINE_KEY */ /* Commented as part of SQ Net change removal - Day1 FY21 */
  WHERE   DRVD.SCA_SOURCE_TYPE_CD IN ('X','R')   
   AND (DRVD.FORWARD_REVERSE_CODE   = 'F' 
   OR DRVD.FORWARD_REVERSE_CODE   = 'FORWARD')     
   AND DRVD.LAST_RECORD_FLAG ='Y'          
   AND NRSCA.EDW_UPDATE_DTM > X.LAST_EXTRACT_DATE  
   AND DRVD.REVENUE_TRANSFER_KEY <> -999
  QUALIFY Rank () Over ( 
  PARTITION BY DRVD.SOURCE_SYSTEM_CODE , DV_TRANSACTION_SOURCE_CD  ,
    DV_TRANSACTION_KEY, NRSCA.EP_TRANSACTION_ID_INT 
  ORDER BY TRANSACTION_SEQUENCE_ID_INT DESC)=1


Post SQL : 



Target2 Name : WI_BKG_TX_SQ_ID_FORWARD1


Pre SQL : 
DELETE FROM $$STGDB.WI_BKG_TX_SQ_ID_FORWARD;


Post SQL : 
COLLECT STATS ON $$STGDB.WI_BKG_TX_SQ_ID_FORWARD;


Source3 Name : SQ_WI_CONTRACT_CHANGE_RT_FWD


Pre SQL : 
DELETE FROM $$STGDB.WI_INCR_SOL_KEYS_ANTY_AR;

INSERT INTO $$STGDB.WI_INCR_SOL_KEYS_ANTY_AR
 SELECT SALES_ORDER_LINE_KEY,SS_CODE FROM (
  SELECT DISTINCT SALES_ORDER_LINE_KEY,SS_CODE
        FROM $$SLSORDVWDB.N_SALES_ORDER_LINE_TV    
        WHERE EDW_UPDATE_DATETIME > ( SELECT LAST_EXTRACT_DATE FROM $$ETLVWDB.CTL_ETL_LAST_EXTRACT_DATES 
         WHERE JOB_STREAM_ID = 'wf_WI_RTE_NET_CHANGE_FOR_BKG'  
           AND TABLE_NAME = 'N_SALES_ORDER_LINE_TV'  
              )
     AND END_TV_DATETIME = '3500-01-01 00:00:00'
  UNION 
  SELECT DISTINCT SALES_ORDER_LINE_KEY,SS_CODE
        FROM $$SLSORDVWDB.N_SALES_ORDER_LINE_V1_TV    
        WHERE EDW_UPDATE_DTM > ( SELECT LAST_EXTRACT_DATE FROM $$ETLVWDB.CTL_ETL_LAST_EXTRACT_DATES 
         WHERE JOB_STREAM_ID = 'wf_WI_RTE_NET_CHANGE_FOR_BKG'  
           AND TABLE_NAME = 'N_SALES_ORDER_LINE_V1_TV'  
              )
    AND END_TV_DTM = '3500-01-01 00:00:00'
  
      ) WI;


SQL Query : 
SELECT
 DRVD_NCR_REV_TRX_BKG_KEY,
 DRVD.TRANSACTION_SEQUENCE_ID_INT,
 DRVD.PROCESS_DATE,
 DRVD.DV_BKGS_SERVICE_FLAG,
 DRVD.REVENUE_TRANSFER_KEY,
 RU_SERVICE_CONTRACT_START_DTM ,
 RU_SERVICE_CONTRACT_END_DTM   ,
 ROUND(DV_CONTRACT_DURATION) AS DV_CONTRACT_DURATION          ,
 RU_SERVICE_CONTRACT_START_DTM AS NEW_CONTRACT_START_DTM,
 RU_SERVICE_CONTRACT_END_DTM  AS NEW_CONTRACT_END_DTM ,
 ROUND(DV_CONTRACT_DURATION) AS NEW_CONTRACT_DURATION ,
 DRVD.DV_SALES_ORDER_LINE_KEY
 FROM $$FINLGLVWDB.N_DRVD_NCR_REV_TRX_FOR_BKG DRVD
 INNER JOIN $$STGDB.WI_INCR_SOL_KEYS_ANTY_AR ST 
 ON DRVD.DV_SALES_ORDER_LINE_KEY=ST.SALES_ORDER_LINE_KEY
 WHERE DRVD.DV_BKGS_SERVICE_FLAG = 'Y' 
 AND DRVD.SOURCE_SYSTEM_CODE IN ('CG','CDC')
 AND (DRVD.FORWARD_REVERSE_CODE = 'FORWARD'   OR DRVD.FORWARD_REVERSE_CODE = 'F') 
 AND DRVD.LAST_RECORD_FLAG = 'Y'
 AND DRVD.SCA_SOURCE_TYPE_CD IN ('X','R')
 AND DRVD.REVENUE_TRANSFER_KEY > 0


Post SQL : 



Target3 Name : WI_CONTRACT_CHANGE_RT_FWD1


Pre SQL : 
DELETE FROM $$STGDB.WI_CONTRACT_CHANGE_RT_FWD;


Post SQL : 
CALL COLLECT_STATS_WRAP('$$STGDB','WI_CONTRACT_CHANGE_RT_FWD','D');                             
 
 /* WILL UPDATE THE CONTRACT INFORMATION IN NEW COLS WHEN THERE IS CHANGE*/
 
 UPDATE WI FROM 
 $$STGDB.WI_CONTRACT_CHANGE_RT_FWD WI , 
 $$SLSORDVWDB.N_SALES_ORDER_LINE_TV SOL
 SET 
 NEW_CONTRACT_START_DTM = SOL.RU_SERVICE_CONTRACT_START_DTM,
 NEW_CONTRACT_END_DTM = SOL.RU_SERVICE_CONTRACT_END_DTM,
 NEW_CONTRACT_DURATION = ROUND(CAST((CAST(CAST(SOL.RU_SERVICE_CONTRACT_END_DTM AS DATE) -  CAST(SOL.RU_SERVICE_CONTRACT_START_DTM AS DATE) AS INTEGER)*12(FLOAT))/365 AS DECIMAL(15,6) ))
 WHERE WI.DV_SALES_ORDER_LINE_KEY = SOL.SALES_ORDER_LINE_KEY 
 AND SOL.END_TV_DATETIME = '3500-01-01 00:00:00'
 AND WI.DV_BKGS_SERVICE_FLAG='Y'
 AND ((( CAST(WI.RU_SERVICE_CONTRACT_END_DTM AS DATE ) - CAST(WI.RU_SERVICE_CONTRACT_START_DTM AS DATE ) )  IS NULL  AND  ( CAST(SOL.RU_SERVICE_CONTRACT_END_DTM AS DATE ) - CAST(SOL.RU_SERVICE_CONTRACT_START_DTM AS DATE ) )  IS NOT  NULL   )
 OR  (( CAST(WI.RU_SERVICE_CONTRACT_END_DTM AS DATE ) - CAST(WI.RU_SERVICE_CONTRACT_START_DTM AS DATE ) )  IS NOT NULL  AND  ( CAST(SOL.RU_SERVICE_CONTRACT_END_DTM AS DATE ) - CAST(SOL.RU_SERVICE_CONTRACT_START_DTM AS DATE ) )  IS   NULL   )
 OR (( CAST(WI.RU_SERVICE_CONTRACT_END_DTM AS DATE )- CAST(WI.RU_SERVICE_CONTRACT_START_DTM AS DATE ))   <>(CAST(SOL.RU_SERVICE_CONTRACT_END_DTM AS DATE )- CAST(SOL.RU_SERVICE_CONTRACT_START_DTM AS DATE ) ))
 );  
 
 /*REFERRING FROM NSOL_V1_TV IF THERE IS NO INFORMATION IN NSOL_TV TABLE*/
 
 UPDATE WI FROM 
 $$STGDB.WI_CONTRACT_CHANGE_RT_FWD WI , 
 $$SLSORDVWDB.N_SALES_ORDER_LINE_V1_TV  SOL
 SET 
 NEW_CONTRACT_DURATION = ROUND(RU_SRVC_CNTRCT_DRTN_MNTHS_CNT)
 WHERE WI.DV_SALES_ORDER_LINE_KEY = SOL.SALES_ORDER_LINE_KEY 
 AND WI.DV_BKGS_SERVICE_FLAG='Y'
 AND SOL.END_TV_DTM = '3500-01-01 00:00:00'
 AND (
 (WI.DV_CONTRACT_DURATION IS NULL AND SOL.RU_SRVC_CNTRCT_DRTN_MNTHS_CNT IS NOT NULL  )
 OR (WI.DV_CONTRACT_DURATION IS NOT NULL AND SOL.RU_SRVC_CNTRCT_DRTN_MNTHS_CNT IS  NULL  )
 OR (WI.DV_CONTRACT_DURATION <>SOL.RU_SRVC_CNTRCT_DRTN_MNTHS_CNT  )
 )
 AND 
 ( CAST(WI.NEW_CONTRACT_START_DTM AS DATE ) - CAST(WI.NEW_CONTRACT_END_DTM AS DATE ) )  IS NULL ;
 
 
 /*CHECKING FOR SERVICE_FLG='N'*/
 
 INSERT INTO $$STGDB.WI_CONTRACT_CHANGE_RT_FWD
 SELECT 
 NDRVD.DRVD_NCR_REV_TRX_BKG_KEY,
 NDRVD.TRANSACTION_SEQUENCE_ID_INT,
 NDRVD.PROCESS_DATE,
 NDRVD.DV_BKGS_SERVICE_FLAG,
 NDRVD.REVENUE_TRANSFER_KEY          ,
 NDRVD.RU_SERVICE_CONTRACT_START_DTM ,
 NDRVD.RU_SERVICE_CONTRACT_END_DTM   ,
 ROUND(NDRVD.DV_CONTRACT_DURATION) AS DV_CONTRACT_DURATION,
 NBM1.NEW_CONTRACT_START_DTM AS NEW_CONTRACT_START_DTM,
 NBM1.NEW_CONTRACT_END_DTM AS NEW_CONTRACT_END_DTM,
 NBM1.NEW_CONTRACT_DURATION AS NEW_CONTRACT_DURATION,
 NDRVD.DV_SALES_ORDER_LINE_KEY
 FROM
 (SELECT 
 NDRVD.DRVD_NCR_REV_TRX_BKG_KEY,
 NDRVD.TRANSACTION_SEQUENCE_ID_INT,
 NDRVD.PROCESS_DATE,
 NDRVD.DV_BKGS_SERVICE_FLAG,
 CAST(NSOL.RU_SERVICE_CONTRACT_START_DTM AS DATE ) AS NEW_CONTRACT_START_DTM,
 CAST(NSOL.RU_SERVICE_CONTRACT_END_DTM AS DATE )  AS NEW_CONTRACT_END_DTM ,
 ROUND(CASE WHEN ( CAST(NSOL.RU_SERVICE_CONTRACT_START_DTM AS DATE ) - CAST(NSOL.RU_SERVICE_CONTRACT_END_DTM AS DATE ) )  IS   NOT NULL 
                                                                   THEN  CAST((CAST(CAST(NSOL.RU_SERVICE_CONTRACT_END_DTM AS DATE) -  CAST(NSOL.RU_SERVICE_CONTRACT_START_DTM AS DATE) AS INTEGER)*12(FLOAT))/365 AS DECIMAL(15,6) )
                                                   WHEN  NSOLV1.RU_SRVC_CNTRCT_DRTN_MNTHS_CNT > 0
                                                                   THEN NSOLV1.RU_SRVC_CNTRCT_DRTN_MNTHS_CNT 
    WHEN ( NP.BK_PRODUCT_ID LIKE 'SWOA%' OR  NP.BK_PRODUCT_ID LIKE '%ADJ%' )AND NP.BK_PRODUCT_ID NOT LIKE 'SWOA-MX%'  THEN NULL
      ELSE CASE
       WHEN NP.PRICING_UNIT_NAME = 'YEAR' THEN NP.PRICING_UNIT_DURATION_INT * 12 
       WHEN NP.PRICING_UNIT_NAME = 'MONTHS' THEN NP.PRICING_UNIT_DURATION_INT  
 /* Added as part of June-2018 Meraki scope - goponnus */  
   WHEN NP.PRICING_UNIT_NAME = 'DAYS' THEN ((NP.PRICING_UNIT_DURATION_INT *12)/365)
      WHEN EL.BIZ_DEF_TERM IS NOT NULL THEN EL.BIZ_DEF_TERM
      WHEN EL.DURATION IS NOT NULL THEN EL.DURATION
  ELSE NULL
      END 
   END)  NEW_CONTRACT_DURATION
   FROM $$FINLGLVWDB.N_DRVD_NCR_REV_TRX_FOR_BKG NDRVD
   INNER JOIN $$STGDB.WI_INCR_SOL_KEYS_ANTY_AR WI
   ON NDRVD.DV_SALES_ORDER_LINE_KEY=WI.SALES_ORDER_LINE_KEY
   INNER JOIN $$SLSORDVWDB.N_SALES_ORDER_LINE_TV NSOL
   ON NDRVD.DV_SALES_ORDER_LINE_KEY   =NSOL.SALES_ORDER_LINE_KEY 
   AND NSOL.END_TV_DATETIME = '3500-01-01 00:00:00'
   INNER JOIN $$SLSORDVWDB.N_SALES_ORDER_LINE_V1_TV  NSOLV1
   ON NDRVD.DV_SALES_ORDER_LINE_KEY   =NSOLV1.SALES_ORDER_LINE_KEY  
   AND NSOLV1.END_TV_DTM = '3500-01-01 00:00:00'
   INNER JOIN $$COMREFVWDB.N_PRODUCT NP
   ON NDRVD.PRODUCT_KEY=NP.ITEM_KEY 
   LEFT OUTER JOIN (SELECT SKU,INVENTORY_ITEM_ID,DURATION,BIZ_DEF_TERM FROM $$ETLVWDB.EL_CG1_XXCFIR_PROD_SUBSCR_SKU WHERE END_DATE IS NULL)EL 
   ON NP.BK_PRODUCT_ID=EL.SKU
   WHERE NDRVD.DV_BKGS_SERVICE_FLAG  ='N'
   AND NDRVD.SOURCE_SYSTEM_CODE IN ('CG','CDC')
   AND (NDRVD.FORWARD_REVERSE_CODE = 'FORWARD'   OR NDRVD.FORWARD_REVERSE_CODE = 'F') 
   AND NDRVD.LAST_RECORD_FLAG = 'Y' 
   AND NDRVD.SCA_SOURCE_TYPE_CD IN ('X','R') AND NDRVD.DV_SALES_ORDER_LINE_KEY>0
   AND NDRVD.REVENUE_TRANSFER_KEY > 0 
   GROUP BY 1,2,3,4,5,6,7
   )NBM1
   INNER JOIN $$FINLGLVWDB.N_DRVD_NCR_REV_TRX_FOR_BKG NDRVD 
   ON NBM1.DRVD_NCR_REV_TRX_BKG_KEY=NDRVD.DRVD_NCR_REV_TRX_BKG_KEY
   WHERE 
   (
   COALESCE(CAST(NBM1.NEW_CONTRACT_START_DTM AS DATE FORMAT 'YYYY-MM-DD'),CAST( '3500-01-01' AS DATE FORMAT 'YYYY-MM-DD') )<> COALESCE(CAST(NDRVD.RU_SERVICE_CONTRACT_START_DTM AS DATE FORMAT 'YYYY-MM-DD'),CAST ('3500-01-01' AS DATE FORMAT 'YYYY-MM-DD'))
   OR COALESCE(CAST(NBM1.NEW_CONTRACT_END_DTM AS DATE FORMAT 'YYYY-MM-DD'),CAST( '3500-01-01' AS DATE FORMAT 'YYYY-MM-DD')) <> COALESCE(CAST(NDRVD.RU_SERVICE_CONTRACT_END_DTM AS DATE FORMAT 'YYYY-MM-DD'),CAST ('3500-01-01' AS DATE FORMAT 'YYYY-MM-DD'))
   OR COALESCE(NBM1.NEW_CONTRACT_DURATION,-1)  <>COALESCE(NDRVD.DV_CONTRACT_DURATION,-1)
   --OR COALESCE(NBM1.ANNUALIZED_FLG,'=' )  <> COALESCE(MEASURE.DV_ANNUALIZED_FLG,'=' ) 
   );


Source4 Name : SQ_WI_RTE_NET_CHANGE_FOR_BKG


Pre SQL : 



SQL Query : 
SELECT 
   ROW_NUMBER()   OVER( ORDER BY WI.SCA_SOURCE_COMMIT_DTM ) /* + SM_MAX.MAX_TRX_SEQ_ID */ AS TRANSACTION_SEQUENCE_ID_INT, /*transaction_seq_id will be calculated while populating to DRVD table */
  DRVD.SOURCE_SYSTEM_CODE,
  CAST(WI.SCA_SOURCE_COMMIT_DTM AS DATE) AS TRANSACTION_DATE,
  ROW_NUMBER()   OVER( ORDER BY WI.SCA_SOURCE_COMMIT_DTM ) /* + SM_MAX.MAX_TRX_SEQ_ID */ AS SK_PH_TRANSACTION_SEQ_ID_INT,
  DRVD.PD_ACCOUNTING_RULE_NAME       ,
  DRVD.ACCOUNT_CLASS_CODE            ,
  DRVD.GL_DISTRIBUTION_FUNCTIONAL_AMT,
  DRVD.ADJUSTMENT_TYPE_CODE          ,
  DRVD.GL_DISTRIB_TRANSACTIONAL_AMT  ,
  DRVD.CREATED_BY_INT                ,
  DRVD.AR_TRX_LINE_TRANSACTIONAL_AMT ,
  DRVD.EXTRACT_TYPE_CODE             ,
  'R' AS FORWARD_REVERSE_CODE,
  DRVD.GL_DATETIME            ,       
  DRVD.GL_DATE                 ,      
  DRVD.GL_POSTED_DATE           ,     
  'I' AS TRANSACTION_GROUPING_TYPE_CODE,
  DRVD.LAST_UPDATED_BY_INT           ,
  'N' AS LAST_RECORD_FLAG,
  DRVD.LINE_TYPE_CODE           ,     
  DRVD.QUOTA_FLAG,
  DRVD.REBATE_TRANSACTIONAL_AMOUNT   ,
  DRVD.MANUAL_TRANSACTION_FLAG       ,
  DRVD.RULE_START_DATETIME           ,
  WI.SCA_SOURCE_COMMIT_DTM AS TRANSACTION_DATETIME,
  DRVD.TRANSACTION_QUANTITY          ,
  DRVD.AR_TRX_DATETIME               ,
  DRVD.AR_TRX_NUMBER                 ,
  DRVD.AR_TRX_TYPE_CODE              ,
  DRVD.UNIT_SELLING_PRICE_TRX_AMT    ,
  DRVD.UNIT_STANDARD_PRICE_TRX_AMT   ,
  DRVD.PD_SALES_TERRITORY_KEY        ,
  DRVD.PD_SALES_REP_NUMBER           ,
  DRVD.PD_AR_ADJUSTMENT_NUMBER       ,
  DRVD.PD_AR_ADJUSTMENT_COMPANY_CODE ,
  DRVD.PD_AR_ADJ_SET_OF_BOOKS_KEY    ,
  DRVD.PD_FUNCTIONAL_CURRENCY_CODE   ,
  DRVD.PD_INVOICE_CURRENCY_CODE      ,
  DRVD.DV_FISCAL_CALENDAR_CODE       ,
  WI.BK_FISCAL_MONTH_NUMBER_INT AS DV_FISCAL_MONTH_NUMBER_INT ,
  WI.BK_FISCAL_YEAR_NUMBER_INT  AS DV_FISCAL_YEAR_NUMBER_INT ,
  DRVD.REPORTING_MEASURE_TYPE        ,
  DRVD.BK_AR_TRX_LINE_GL_DISTRIB_KEY ,
  CAST(WI.SCA_SOURCE_COMMIT_DTM AS DATE) AS DV_FISCAL_DATE, 
  DRVD.DV_BKGS_ITEM_TYPE_CODE_FLAG   ,
  DRVD.DV_BKGS_INTL_DEMO_FLAG        ,
  DRVD.DV_BKGS_REPL_DEMO_FLAG        ,
  DRVD.DV_BKGS_REVENUE_FLAG          ,
  DRVD.DV_BKGS_OVERLAY_FLAG          ,
  DRVD.DV_BKGS_SALESREP_FLAG         ,
  DRVD.DV_BKGS_IC_REVENUE_FLAG       ,
  DRVD.DV_BKGS_CHARGES_FLAG          ,
  DRVD.DV_BKGS_MISC_FLAG             ,
  DRVD.DV_BKGS_SERVICE_FLAG          ,
  DRVD.DV_BKGS_CORP_BKG_FLAG         ,
  DRVD.DV_BKGS_COMP_US_NET_PRC_AMT   * -1 AS DV_BKGS_COMP_US_NET_PRC_AMT,
  DRVD.DV_BKGS_COMP_US_LST_PRC_AMT   * -1 AS DV_BKGS_COMP_US_LST_PRC_AMT,
  DRVD.DV_BKGS_COMP_US_COST_AMT      * -1 AS DV_BKGS_COMP_US_COST_AMT,
  DRVD.DV_BKGS_EXTENDED_QUANTITY     ,
  DRVD.BK_SCAA_SALES_REP_NUMBER      ,
  DRVD.BK_SCAN_SALES_REP_NUMBER      ,
  DRVD.SALES_COMMISSION_PERCENTAGE   * -1 AS SALES_COMMISSION_PERCENTAGE,
  DRVD.SALES_CHANNEL_CODE            ,
  DRVD.DV_COMP_US_STANDARD_PRICE_AMT ,
  WI.DV_FISCAL_YEAR_MONTH_NUM_INT AS DV_FISCAL_YEAR_MTH_NUMBER_INT,
  DRVD.REPORTED_SALES_ORDER_NUM_INT  ,
  CAST(BPDC.PROCESS_DATE AS DATE) AS PROCESS_DATE ,
  DRVD.AR_TRX_KEY    ,                
  DRVD.AR_TRX_LINE_KEY,               
  DRVD.PRODUCT_KEY     ,              
  DRVD.SALES_ORDER_KEY  ,             
   /*DRVD.SALES_ORDER_LINE_KEY commented by sabanil as a part of RTEQ1FY15*/
  DRVD.DV_SALES_ORDER_LINE_KEY       ,/*RTEQ1FY15*/
  DRVD.SHIP_TO_CUSTOMER_KEY          ,
  DRVD.SOLD_TO_CUSTOMER_KEY          ,
  DRVD.BILL_TO_CUSTOMER_KEY          ,
  DRVD.SALES_CREDIT_TYPE_CODE        ,
  USER,
  USER,
  CURRENT_TIMESTAMP(0),
  CURRENT_TIMESTAMP(0),
  DRVD.CONVERSION_RT   ,              
  DRVD.DV_TRANSACTION_NAME           ,
  DRVD.DEFAULT_SC_FLG                ,
  DRVD.SK_LINE_SEQ_ID_INT            ,
  DRVD.SCA_SOURCE_TYPE_CD            ,
  DRVD.DV_TRANSACTION_SOURCE_CD      ,
  DRVD.DV_TRANSACTION_KEY            ,
   DRVD.TRANSACTION_SEQUENCE_ID_INT AS OLD_TRANSACTION_SEQ_ID,
  'INSERT' AS EVENT_TYPE,
  DRVD.DV_TRX_AMT, 
  DRVD.DV_FUNC_AMT, 
  DRVD.DV_TRX_QTY ,
  DRVD.SALES_MOTION_CD,
  DRVD.RU_SERVICE_CONTRACT_START_DTM,
  DRVD.RU_SERVICE_CONTRACT_END_DTM   ,
  DRVD.DV_CONTRACT_DURATION          ,
  DRVD.DV_ANNUALIZED_FLG             ,
  DRVD.DV_ANNUALIZED_US_NET_AMT      ,
  DRVD.DV_MULTIYEAR_US_NET_AMT       ,
  DRVD.BOOKINGS_POLICY_CD
   FROM $$FINLGLVWDB.N_DRVD_NCR_REV_TRX_FOR_BKG DRVD
  INNER JOIN $$STGDB.WI_BKG_TX_SQ_ID_RTE WI
   ON  DRVD.TRANSACTION_SEQUENCE_ID_INT = WI.BK_TRANSACTION_SEQ_ID_INT
   AND DRVD.SOURCE_SYSTEM_CODE = WI.BK_SS_CD 
   INNER JOIN $$FINLGLVWDB.N_REVENUE_TRANSFER NRA
  ON(NRA.REVENUE_TRANSFER_KEY=DRVD.REVENUE_TRANSFER_KEY)
  INNER JOIN $$SLSORDVWDB.N_SCA_FOR_RTE_TRX  NRSCA
    ON NRSCA.EP_TRANSACTION_ID_INT = NRA.EP_TRANSACTION_ID_INT   
  INNER JOIN $$ETLVWDB.SM_SCA_FOR_RTE_TRX SRSCA
  ON (SRSCA.SALES_CREDIT_ASSIGNMENT_KEY=NRSCA.SALES_CREDIT_ASSIGNMENT_KEY )
  INNER JOIN (SELECT PROCESS_DATE FROM $$ETLVWDB.BKG_PROCESS_DT_CNTRL) BPDC
   ON 1=1
  QUALIFY ROW_NUMBER () OVER ( PARTITION BY  DRVD.DV_TRANSACTION_SOURCE_CD      , DRVD.DV_TRANSACTION_KEY,   NRSCA.EP_TRANSACTION_ID_INT , DRVD.SK_LINE_SEQ_ID_INT
  ORDER BY WI.BK_TRANSACTION_SEQ_ID_INT DESC)=1


Post SQL : 



Target4 Name : WI_RTE_NET_CHANGE_FOR_BKG2


Pre SQL : 
DELETE FROM $$STGDB.WI_RTE_NET_CHANGE_FOR_BKG;


Post SQL : 



Source5 Name : SQ_WI_RTE_NET_CHANGE_FOR_BKG1


Pre SQL : 



SQL Query : 
SELECT
  ROW_NUMBER()  OVER( ORDER BY WI.SCA_SOURCE_COMMIT_DTM ) /* + SM_MAX.MAX_TRX_SEQ_ID */  AS TRANSACTION_SEQUENCE_ID_INT , 
  DRVD.SOURCE_SYSTEM_CODE,
  CAST(WI.SCA_SOURCE_COMMIT_DTM AS DATE) AS TRANSACTION_DATE,
  ROW_NUMBER()  OVER( ORDER BY WI.SCA_SOURCE_COMMIT_DTM ) /* + SM_MAX.MAX_TRX_SEQ_ID */ AS SK_PH_TRANSACTION_SEQ_ID_INT,
  DRVD.PD_ACCOUNTING_RULE_NAME       ,
  DRVD.ACCOUNT_CLASS_CODE            ,
  DRVD.GL_DISTRIBUTION_FUNCTIONAL_AMT,
  DRVD.ADJUSTMENT_TYPE_CODE          ,
  DRVD.GL_DISTRIB_TRANSACTIONAL_AMT  ,
  DRVD.CREATED_BY_INT                ,
  DRVD.AR_TRX_LINE_TRANSACTIONAL_AMT ,
  DRVD.EXTRACT_TYPE_CODE             ,
  'F' AS FORWARD_REVERSE_CODE,
  DRVD.GL_DATETIME            ,       
  DRVD.GL_DATE  AS GL_DATE                 ,      
  DRVD.GL_POSTED_DATE           ,     
  'I' AS TRANSACTION_GROUPING_TYPE_CODE,
  DRVD.LAST_UPDATED_BY_INT           ,
  'Y' AS LAST_RECORD_FLAG,
  DRVD.LINE_TYPE_CODE     ,           
  WI.QUOTA_FLAG,    
  DRVD.REBATE_TRANSACTIONAL_AMOUNT   ,
  DRVD.MANUAL_TRANSACTION_FLAG       ,
  DRVD.RULE_START_DATETIME           ,
  WI.SCA_SOURCE_COMMIT_DTM AS TRANSACTION_DATETIME,
  DRVD.TRANSACTION_QUANTITY          ,
  DRVD.AR_TRX_DATETIME               ,
  DRVD.AR_TRX_NUMBER                 ,
  DRVD.AR_TRX_TYPE_CODE              ,
  DRVD.UNIT_SELLING_PRICE_TRX_AMT    ,
  DRVD.UNIT_STANDARD_PRICE_TRX_AMT   ,
  WI.SALES_TERRITORY_KEY AS PD_SALES_TERRITORY_KEY,  
  WI.SALES_REP_NUMBER AS PD_SALES_REP_NUMBER,  
  DRVD.PD_AR_ADJUSTMENT_NUMBER       ,
  DRVD.PD_AR_ADJUSTMENT_COMPANY_CODE ,
  DRVD.PD_AR_ADJ_SET_OF_BOOKS_KEY    ,
  DRVD.PD_FUNCTIONAL_CURRENCY_CODE   ,
  DRVD.PD_INVOICE_CURRENCY_CODE      ,
  DRVD.DV_FISCAL_CALENDAR_CODE       ,
  WI.BK_FISCAL_MONTH_NUMBER_INT AS DV_FISCAL_MONTH_NUMBER_INT ,
  WI.BK_FISCAL_YEAR_NUMBER_INT  AS DV_FISCAL_YEAR_NUMBER_INT ,
  DRVD.REPORTING_MEASURE_TYPE        ,
  DRVD.BK_AR_TRX_LINE_GL_DISTRIB_KEY ,
  CAST(WI.SCA_SOURCE_COMMIT_DTM AS DATE) AS DV_FISCAL_DATE, 
  DRVD.DV_BKGS_ITEM_TYPE_CODE_FLAG   ,
  DRVD.DV_BKGS_INTL_DEMO_FLAG        ,
  DRVD.DV_BKGS_REPL_DEMO_FLAG        ,
  DRVD.DV_BKGS_REVENUE_FLAG          ,
  CASE WHEN (WI.EP_SK_TERRITORY_ID_INT IS NULL OR WI.EP_SK_TERRITORY_ID_INT = -999) THEN 'Y' ELSE 'N' END DV_BKGS_OVERLAY_FLAG,
  CASE WHEN WI.EP_SK_SALESREP_ID_INT = -999 THEN 'Y'ELSE 'N' END DV_BKGS_SALESREP_FLAG ,
  DRVD.DV_BKGS_IC_REVENUE_FLAG       ,
  DRVD.DV_BKGS_CHARGES_FLAG          ,
  DRVD.DV_BKGS_MISC_FLAG             ,
  DRVD.DV_BKGS_SERVICE_FLAG          ,
  CASE WHEN DRVD.SOLD_TO_CUSTOMER_KEY=-999
     THEN (
       CASE WHEN  ( NCA1.ERP_CUSTOMER_TYPE_CODE IS NULL    
           OR NCA1.ERP_CUSTOMER_TYPE_CODE<>'I'  
             )  
           AND DRVD.DV_BKGS_INTL_DEMO_FLAG='N' 
           AND DRVD.DV_BKGS_REPL_DEMO_FLAG='N' 
           AND DRVD.DV_BKGS_REVENUE_FLAG='Y' 
           AND DRVD.DV_BKGS_CHARGES_FLAG='N' 
           AND (CASE WHEN (WI.EP_SK_TERRITORY_ID_INT IS NULL OR WI.EP_SK_TERRITORY_ID_INT = -999) THEN 'Y' ELSE 'N' END )='N'   
           AND DRVD.DV_BKGS_ITEM_TYPE_CODE_FLAG='N' 
           AND DRVD.DV_BKGS_MISC_FLAG='N' 
           AND (CASE WHEN WI.EP_SK_SALESREP_ID_INT = -999 THEN 'Y'ELSE 'N' END )='N'  
         THEN 'Y' 
        ELSE 'N' 
       END
      )
    ELSE 
    ( CASE WHEN  (NCA.ERP_CUSTOMER_TYPE_CODE IS NULL  
         OR NCA.ERP_CUSTOMER_TYPE_CODE<>'I')   
         AND DRVD.DV_BKGS_INTL_DEMO_FLAG='N' 
         AND DRVD.DV_BKGS_REPL_DEMO_FLAG='N' 
         AND DRVD.DV_BKGS_REVENUE_FLAG='Y' 
         AND DRVD.DV_BKGS_CHARGES_FLAG='N' 
         AND (CASE WHEN (WI.EP_SK_TERRITORY_ID_INT IS NULL OR WI.EP_SK_TERRITORY_ID_INT = -999) THEN 'Y' ELSE 'N' END )='N' 
         AND DRVD.DV_BKGS_ITEM_TYPE_CODE_FLAG='N' 
         AND DRVD.DV_BKGS_MISC_FLAG='N' 
         AND (CASE WHEN WI.EP_SK_SALESREP_ID_INT = -999 THEN 'Y'ELSE 'N' END )='N' 
       THEN 'Y' 
      ELSE 'N' 
     END 
    ) 
  END DV_BKGS_CORP_BKG_FLAG,
  
  CASE WHEN COALESCE(DRVD.SALES_COMMISSION_PERCENTAGE,100) =0 THEN DRVD.DV_BKGS_COMP_US_NET_PRC_AMT
   ELSE DRVD.DV_BKGS_COMP_US_NET_PRC_AMT  * (  WI.SCA_SALES_COMMISSION_PCT/ COALESCE(DRVD.SALES_COMMISSION_PERCENTAGE,100))    
  END AS DV_BKGS_COMP_US_NET_PRC_AMT,
  
  CASE WHEN COALESCE(DRVD.SALES_COMMISSION_PERCENTAGE,100) =0 THEN DRVD.DV_BKGS_COMP_US_LST_PRC_AMT
   ELSE DRVD.DV_BKGS_COMP_US_LST_PRC_AMT  * (  WI.SCA_SALES_COMMISSION_PCT/ COALESCE(DRVD.SALES_COMMISSION_PERCENTAGE,100))    
  END AS DV_BKGS_COMP_US_LST_PRC_AMT,
  
  CASE WHEN COALESCE(DRVD.SALES_COMMISSION_PERCENTAGE,100) =0 THEN DRVD.DV_BKGS_COMP_US_COST_AMT
   ELSE DRVD.DV_BKGS_COMP_US_COST_AMT  * (  WI.SCA_SALES_COMMISSION_PCT/ COALESCE(DRVD.SALES_COMMISSION_PERCENTAGE,100))    
  END AS DV_BKGS_COMP_US_COST_AMT,
  
  DRVD.DV_BKGS_EXTENDED_QUANTITY     ,
  
  CASE WHEN DRVD.DV_SALES_ORDER_LINE_KEY /*RTEQ1FY15:replaced sales_order_line_key with dv_sales_order_line_key*/
  IN (-9999,-8888, -7777) THEN 'UNKNOWN' ELSE WI.SALES_REP_NUMBER  END AS BK_SCAA_SALES_REP_NUMBER,   
  CASE WHEN DRVD.DV_SALES_ORDER_LINE_KEY /*RTEQ1FY15:replaced sales_order_line_key with dv_sales_order_line_key*/
  IN (-9999,-8888, -7777) THEN WI.SALES_REP_NUMBER ELSE 'UNKNOWN' END BK_SCAN_SALES_REP_NUMBER,       
  WI.SCA_SALES_COMMISSION_PCT AS SALES_COMMISSION_PERCENTAGE,
  DRVD.SALES_CHANNEL_CODE            ,
  DRVD.DV_COMP_US_STANDARD_PRICE_AMT ,
  WI.DV_FISCAL_YEAR_MONTH_NUM_INT AS DV_FISCAL_YEAR_MTH_NUMBER_INT,
  DRVD.REPORTED_SALES_ORDER_NUM_INT  ,
  BPDC.PROCESS_DATE ,
  DRVD.AR_TRX_KEY    ,                
  DRVD.AR_TRX_LINE_KEY,               
  DRVD.PRODUCT_KEY     ,              
  DRVD.SALES_ORDER_KEY  ,  
  /*DRVD.SALES_ORDER_LINE_KEY commented by sabanil as a part of RTEQ1FY15*/
  DRVD.DV_SALES_ORDER_LINE_KEY       ,/*RTEQ1FY15*/
  DRVD.SHIP_TO_CUSTOMER_KEY          ,
  DRVD.SOLD_TO_CUSTOMER_KEY          ,
  DRVD.BILL_TO_CUSTOMER_KEY          ,
  WI.BK_SALES_CREDIT_TYPE_CODE AS SALES_CREDIT_TYPE_CODE  ,   
  USER,
  USER,
  CURRENT_TIMESTAMP(0),
  CURRENT_TIMESTAMP(0),
  DRVD.CONVERSION_RT   ,              
  DRVD.DV_TRANSACTION_NAME           ,
  '=' AS DEFAULT_SC_FLG,
  WI.SK_LINE_SEQ_ID_INT AS SK_LINE_SEQ_ID_INT,
  WI.SCA_SOURCE_TYPE_CD AS SCA_SOURCE_TYPE_CD,
  DRVD.DV_TRANSACTION_SOURCE_CD      ,
  DRVD.DV_TRANSACTION_KEY            ,
   DRVD.TRANSACTION_SEQUENCE_ID_INT AS OLD_TRANSACTION_SEQ_ID,
  'INSERT' AS EVENT_TYPE ,
  DRVD.DV_TRX_AMT, 
  DRVD.DV_FUNC_AMT, 
  DRVD.DV_TRX_QTY ,
  WI.SALES_MOTION_CD  ,
  DRVD.RU_SERVICE_CONTRACT_START_DTM ,
  DRVD.RU_SERVICE_CONTRACT_END_DTM   ,
  DRVD.DV_CONTRACT_DURATION          ,
  DRVD.DV_ANNUALIZED_FLG             ,
  DRVD.DV_ANNUALIZED_US_NET_AMT      ,
  DRVD.DV_MULTIYEAR_US_NET_AMT       ,
  DRVD.BOOKINGS_POLICY_CD  
  FROM $$FINLGLVWDB.N_DRVD_NCR_REV_TRX_FOR_BKG DRVD
  INNER JOIN $$COMREFVWDB.N_SOURCE_SYSTEM_CODES NSSC 
   ON (DRVD.SOURCE_SYSTEM_CODE  = NSSC.SOURCE_SYSTEM_CODE) 
  INNER JOIN $$STGDB.WI_BKG_TX_SQ_ID_FORWARD WI
   ON    DRVD.TRANSACTION_SEQUENCE_ID_INT    = WI.BK_TRANSACTION_SEQ_ID_INT  
   AND DRVD.SOURCE_SYSTEM_CODE = WI.BK_SS_CD
  INNER JOIN $$FINLGLVWDB.N_REVENUE_TRANSFER NRA
  ON(NRA.REVENUE_TRANSFER_KEY=DRVD.REVENUE_TRANSFER_KEY)
  INNER JOIN $$SLSORDVWDB.N_SCA_FOR_RTE_TRX  NRSCA
  ON  NRSCA.SK_LINE_SEQ_ID_INT=WI.SK_LINE_SEQ_ID_INT 
 
   INNER JOIN $$FINLGLVWDB.N_AR_TRX NARTRX
   ON (DRVD.AR_TRX_KEY = NARTRX.AR_TRX_KEY) 
  INNER JOIN $$COMREFVWDB.N_ERP_CUST_ACCT_LOC_USE NECAL  
   ON (NECAL.ERP_CUST_ACCOUNT_LOCATION_KEY = NARTRX.BILL_TO_CUSTOMER_KEY)  
  INNER JOIN  $$COMREFVWDB.N_CUSTOMER_ACCOUNT NCA1  
   ON (NCA1.CUSTOMER_ACCOUNT_KEY = NECAL.CUSTOMER_ACCOUNT_KEY)  
  INNER JOIN $$COMREFVWDB.N_CUSTOMER_ACCOUNT NCA 
   ON (NCA.CUSTOMER_ACCOUNT_KEY = NARTRX.SOLD_TO_CUSTOMER_KEY)
   INNER JOIN (SELECT PROCESS_DATE FROM  $$ETLVWDB.BKG_PROCESS_DT_CNTRL ) BPDC 
  ON 1=1


Post SQL : 



Target5 Name : WI_RTE_NET_CHANGE_FOR_BKG3


Pre SQL : 



Post SQL : 
COLLECT STATS ON $$STGDB.WI_RTE_NET_CHANGE_FOR_BKG;


Source6 Name : SQ_WI_RTE_NET_CHANGE_FOR_BKG_CNTRCT_CHG_R


Pre SQL : 



SQL Query : 
SELECT 
    ROW_NUMBER()   OVER( ORDER BY DRVD.TRANSACTION_DATE ) /* + SM_MAX.MAX_TRX_SEQ_ID */ AS TRANSACTION_SEQUENCE_ID_INT,
   DRVD.SOURCE_SYSTEM_CODE,
   CURRENT_DATE AS TRANSACTION_DATE,
   ROW_NUMBER()   OVER( ORDER BY DRVD.TRANSACTION_DATE ) /* + SM_MAX.MAX_TRX_SEQ_ID */ AS SK_PH_TRANSACTION_SEQ_ID_INT,
   DRVD.PD_ACCOUNTING_RULE_NAME       ,
   DRVD.ACCOUNT_CLASS_CODE            ,
   DRVD.GL_DISTRIBUTION_FUNCTIONAL_AMT,
   DRVD.ADJUSTMENT_TYPE_CODE          ,
   DRVD.GL_DISTRIB_TRANSACTIONAL_AMT  ,
   DRVD.CREATED_BY_INT                ,
   DRVD.AR_TRX_LINE_TRANSACTIONAL_AMT ,
   DRVD.EXTRACT_TYPE_CODE             ,
   'R' AS FORWARD_REVERSE_CODE,
   DRVD.GL_DATETIME            ,       
   DRVD.GL_DATE                 ,      
   DRVD.GL_POSTED_DATE           ,     
   'I' AS TRANSACTION_GROUPING_TYPE_CODE,
   DRVD.LAST_UPDATED_BY_INT           ,
   'N' AS LAST_RECORD_FLAG,
   DRVD.LINE_TYPE_CODE           ,     
   DRVD.QUOTA_FLAG,
   DRVD.REBATE_TRANSACTIONAL_AMOUNT   ,
   DRVD.MANUAL_TRANSACTION_FLAG       ,
   DRVD.RULE_START_DATETIME           ,
   CURRENT_DATE AS TRANSACTION_DATETIME,
   DRVD.TRANSACTION_QUANTITY          ,
   DRVD.AR_TRX_DATETIME               ,
   DRVD.AR_TRX_NUMBER                 ,
   DRVD.AR_TRX_TYPE_CODE              ,
   DRVD.UNIT_SELLING_PRICE_TRX_AMT    ,
   DRVD.UNIT_STANDARD_PRICE_TRX_AMT   ,
   DRVD.PD_SALES_TERRITORY_KEY        ,
   DRVD.PD_SALES_REP_NUMBER           ,
   DRVD.PD_AR_ADJUSTMENT_NUMBER       ,
   DRVD.PD_AR_ADJUSTMENT_COMPANY_CODE ,
   DRVD.PD_AR_ADJ_SET_OF_BOOKS_KEY    ,
   DRVD.PD_FUNCTIONAL_CURRENCY_CODE   ,
   DRVD.PD_INVOICE_CURRENCY_CODE      ,
   DRVD.DV_FISCAL_CALENDAR_CODE       ,
   NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT AS DV_FISCAL_MONTH_NUMBER_INT ,
   NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT  AS DV_FISCAL_YEAR_NUMBER_INT ,
   DRVD.REPORTING_MEASURE_TYPE        ,
   DRVD.BK_AR_TRX_LINE_GL_DISTRIB_KEY ,
   DRVD.DV_FISCAL_DATE, 
   DRVD.DV_BKGS_ITEM_TYPE_CODE_FLAG   ,
   DRVD.DV_BKGS_INTL_DEMO_FLAG        ,
   DRVD.DV_BKGS_REPL_DEMO_FLAG        ,
   DRVD.DV_BKGS_REVENUE_FLAG          ,
   DRVD.DV_BKGS_OVERLAY_FLAG          ,
   DRVD.DV_BKGS_SALESREP_FLAG         ,
   DRVD.DV_BKGS_IC_REVENUE_FLAG       ,
   DRVD.DV_BKGS_CHARGES_FLAG          ,
   DRVD.DV_BKGS_MISC_FLAG             ,
   DRVD.DV_BKGS_SERVICE_FLAG          ,
   DRVD.DV_BKGS_CORP_BKG_FLAG         ,
   DRVD.DV_BKGS_COMP_US_NET_PRC_AMT   * -1 AS DV_BKGS_COMP_US_NET_PRC_AMT,
   DRVD.DV_BKGS_COMP_US_LST_PRC_AMT   * -1 AS DV_BKGS_COMP_US_LST_PRC_AMT,
   DRVD.DV_BKGS_COMP_US_COST_AMT      * -1 AS DV_BKGS_COMP_US_COST_AMT,
   DRVD.DV_BKGS_EXTENDED_QUANTITY     ,
   DRVD.BK_SCAA_SALES_REP_NUMBER      ,
   DRVD.BK_SCAN_SALES_REP_NUMBER      ,
   DRVD.SALES_COMMISSION_PERCENTAGE   * -1 AS SALES_COMMISSION_PERCENTAGE,
   DRVD.SALES_CHANNEL_CODE            ,
   DRVD.DV_COMP_US_STANDARD_PRICE_AMT ,
   (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT * 100 ) AS DV_FISCAL_YEAR_MTH_NUMBER_INT,
   DRVD.REPORTED_SALES_ORDER_NUM_INT  ,
   CAST(BPDC.PROCESS_DATE AS DATE) AS PROCESS_DATE ,
   DRVD.AR_TRX_KEY    ,                
   DRVD.AR_TRX_LINE_KEY,               
   DRVD.PRODUCT_KEY     ,              
   DRVD.SALES_ORDER_KEY  ,             
   DRVD.DV_SALES_ORDER_LINE_KEY       ,
   DRVD.SHIP_TO_CUSTOMER_KEY          ,
   DRVD.SOLD_TO_CUSTOMER_KEY          ,
   DRVD.BILL_TO_CUSTOMER_KEY          ,
   DRVD.SALES_CREDIT_TYPE_CODE        ,
   USER,
   USER,
   CURRENT_TIMESTAMP(0),
   CURRENT_TIMESTAMP(0),
   DRVD.CONVERSION_RT   ,              
   DRVD.DV_TRANSACTION_NAME           ,
   DRVD.DEFAULT_SC_FLG                ,
   DRVD.SK_LINE_SEQ_ID_INT            ,
   DRVD.SCA_SOURCE_TYPE_CD            ,
   DRVD.DV_TRANSACTION_SOURCE_CD      ,
   DRVD.DV_TRANSACTION_KEY            ,
    DRVD.TRANSACTION_SEQUENCE_ID_INT AS OLD_TRANSACTION_SEQ_ID,
   'INSERT' AS EVENT_TYPE,
   DRVD.DV_TRX_AMT, 
   DRVD.DV_FUNC_AMT, 
   DRVD.DV_TRX_QTY ,
   DRVD.SALES_MOTION_CD,  
   DRVD.RU_SERVICE_CONTRACT_START_DTM 
  ,DRVD.RU_SERVICE_CONTRACT_END_DTM   
  ,DRVD.DV_CONTRACT_DURATION          
  ,DRVD.DV_ANNUALIZED_FLG             
  ,DRVD.DV_ANNUALIZED_US_NET_AMT      
  ,DRVD.DV_MULTIYEAR_US_NET_AMT       
  ,DRVD.BOOKINGS_POLICY_CD
    FROM $$FINLGLVWDB.N_DRVD_NCR_REV_TRX_FOR_BKG DRVD
   INNER JOIN $$STGDB.WI_CONTRACT_CHANGE_RT_FWD WI
    ON  DRVD.DRVD_NCR_REV_TRX_BKG_KEY = WI.DRVD_NCR_REV_TRX_BKG_KEY
   INNER JOIN (SELECT PROCESS_DATE FROM $$ETLVWDB.BKG_PROCESS_DT_CNTRL) BPDC
    ON 1=1
  INNER JOIN  
 ( SELECT BK_FISCAL_MONTH_NUMBER_INT, BK_FISCAL_YEAR_NUMBER_INT
    FROM $$COMREFVWDB.N_FISCAL_MONTH 
   WHERE CURRENT_DATE-1 BETWEEN FISCAL_MONTH_START_DATE AND FISCAL_MONTH_END_DATE 
 ) NFISMN_SYS ON 1=1


Post SQL : 



Target6 Name : WI_RTE_NET_CHANGE_FOR_BKG6


Pre SQL : 
/*UPDATING DURATION TO NULL IF VALUE IS -999*/

UPDATE WI FROM $$STGDB.WI_CONTRACT_CHANGE_RT_FWD WI
SET NEW_CONTRACT_DURATION=NULL
WHERE WI.NEW_CONTRACT_DURATION=(-999);

UPDATE WI FROM $$STGDB.WI_CONTRACT_CHANGE_RT_FWD WI
SET NEW_CONTRACT_START_DTM=NULL
WHERE WI.NEW_CONTRACT_START_DTM IN ('1900-01-01 00:00:00','3500-01-01 00:00:00');

UPDATE WI FROM $$STGDB.WI_CONTRACT_CHANGE_RT_FWD WI
SET NEW_CONTRACT_END_DTM=NULL
WHERE WI.NEW_CONTRACT_END_DTM IN ('1900-01-01 00:00:00','3500-01-01 00:00:00');

/*WILL DELETE RECORDS FOR WHICH THERE IS NO CHANGE*/   

DELETE FROM $$STGDB.WI_CONTRACT_CHANGE_RT_FWD WI
WHERE (COALESCE(CAST(WI.RU_SERVICE_CONTRACT_START_DTM AS DATE FORMAT 'YYYY-MM-DD'),CAST( '3500-01-01' AS DATE FORMAT 'YYYY-MM-DD') )= COALESCE(CAST(WI.NEW_CONTRACT_START_DTM AS DATE FORMAT 'YYYY-MM-DD'),CAST ('3500-01-01' AS DATE FORMAT 'YYYY-MM-DD'))
AND   COALESCE(CAST(WI.RU_SERVICE_CONTRACT_END_DTM AS DATE FORMAT 'YYYY-MM-DD'),CAST( '3500-01-01' AS DATE FORMAT 'YYYY-MM-DD')) = COALESCE(CAST(WI.NEW_CONTRACT_END_DTM AS DATE FORMAT 'YYYY-MM-DD'),CAST ('3500-01-01' AS DATE FORMAT 'YYYY-MM-DD'))
AND   COALESCE(WI.DV_CONTRACT_DURATION,-999) = COALESCE(WI.NEW_CONTRACT_DURATION,-999) /*CHANGED VALUE FROM -1 TO -999 TO CONSIDER -999 AS NULL*/
);



/*Deleting records if already loaded earlier*/

UPDATE WI 
FROM $$STGDB.WI_RTE_NET_CHANGE_FOR_BKG WI ,
$$STGDB.WI_CONTRACT_CHANGE_RT_FWD FWD
SET RU_SERVICE_CONTRACT_START_DTM=FWD.NEW_CONTRACT_START_DTM,
RU_SERVICE_CONTRACT_END_DTM=FWD.NEW_CONTRACT_END_DTM,
DV_CONTRACT_DURATION=FWD.NEW_CONTRACT_DURATION
WHERE WI.OLD_TRANSACTION_SEQ_ID=FWD.TRANSACTION_SEQUENCE_ID_INT
AND WI.FORWARD_REVERSE_CODE IN ('F','FORWARD');

DELETE FROM $$STGDB.WI_CONTRACT_CHANGE_RT_FWD WI
WHERE REVENUE_TRANSFER_KEY IN (SELECT DV_TRANSACTION_KEY FROM $$STGDB.WI_RTE_NET_CHANGE_FOR_BKG);


Post SQL : 



Source7 Name : SQ_WI_RTE_NET_CHANGE_FOR_BKG_CNTRCT_CHG_F


Pre SQL : 



SQL Query : 
SELECT 
    ROW_NUMBER()   OVER( ORDER BY DRVD.TRANSACTION_DATE ) /* + SM_MAX.MAX_TRX_SEQ_ID */ AS TRANSACTION_SEQUENCE_ID_INT,
   DRVD.SOURCE_SYSTEM_CODE,
   CURRENT_DATE AS TRANSACTION_DATE,
   ROW_NUMBER()   OVER( ORDER BY DRVD.TRANSACTION_DATE ) /* + SM_MAX.MAX_TRX_SEQ_ID */ AS SK_PH_TRANSACTION_SEQ_ID_INT,
   DRVD.PD_ACCOUNTING_RULE_NAME       ,
   DRVD.ACCOUNT_CLASS_CODE            ,
   DRVD.GL_DISTRIBUTION_FUNCTIONAL_AMT,
   DRVD.ADJUSTMENT_TYPE_CODE          ,
   DRVD.GL_DISTRIB_TRANSACTIONAL_AMT  ,
   DRVD.CREATED_BY_INT                ,
   DRVD.AR_TRX_LINE_TRANSACTIONAL_AMT ,
   DRVD.EXTRACT_TYPE_CODE             ,
   'F' AS FORWARD_REVERSE_CODE,
   DRVD.GL_DATETIME            ,       
   DRVD.GL_DATE                 ,      
   DRVD.GL_POSTED_DATE           ,     
   'I' AS TRANSACTION_GROUPING_TYPE_CODE,
   DRVD.LAST_UPDATED_BY_INT           ,
   'Y' AS LAST_RECORD_FLAG,
   DRVD.LINE_TYPE_CODE           ,     
   DRVD.QUOTA_FLAG,
   DRVD.REBATE_TRANSACTIONAL_AMOUNT   ,
   DRVD.MANUAL_TRANSACTION_FLAG       ,
   DRVD.RULE_START_DATETIME           ,
   CURRENT_DATE AS TRANSACTION_DATETIME,
   DRVD.TRANSACTION_QUANTITY          ,
   DRVD.AR_TRX_DATETIME               ,
   DRVD.AR_TRX_NUMBER                 ,
   DRVD.AR_TRX_TYPE_CODE              ,
   DRVD.UNIT_SELLING_PRICE_TRX_AMT    ,
   DRVD.UNIT_STANDARD_PRICE_TRX_AMT   ,
   DRVD.PD_SALES_TERRITORY_KEY        ,
   DRVD.PD_SALES_REP_NUMBER           ,
   DRVD.PD_AR_ADJUSTMENT_NUMBER       ,
   DRVD.PD_AR_ADJUSTMENT_COMPANY_CODE ,
   DRVD.PD_AR_ADJ_SET_OF_BOOKS_KEY    ,
   DRVD.PD_FUNCTIONAL_CURRENCY_CODE   ,
   DRVD.PD_INVOICE_CURRENCY_CODE      ,
   DRVD.DV_FISCAL_CALENDAR_CODE       ,
   NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT AS DV_FISCAL_MONTH_NUMBER_INT ,
   NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT  AS DV_FISCAL_YEAR_NUMBER_INT ,
   DRVD.REPORTING_MEASURE_TYPE        ,
   DRVD.BK_AR_TRX_LINE_GL_DISTRIB_KEY ,
   DRVD.DV_FISCAL_DATE, 
   DRVD.DV_BKGS_ITEM_TYPE_CODE_FLAG   ,
   DRVD.DV_BKGS_INTL_DEMO_FLAG        ,
   DRVD.DV_BKGS_REPL_DEMO_FLAG        ,
   DRVD.DV_BKGS_REVENUE_FLAG          ,
   DRVD.DV_BKGS_OVERLAY_FLAG          ,
   DRVD.DV_BKGS_SALESREP_FLAG         ,
   DRVD.DV_BKGS_IC_REVENUE_FLAG       ,
   DRVD.DV_BKGS_CHARGES_FLAG          ,
   DRVD.DV_BKGS_MISC_FLAG             ,
   DRVD.DV_BKGS_SERVICE_FLAG          ,
   DRVD.DV_BKGS_CORP_BKG_FLAG         ,
   DRVD.DV_BKGS_COMP_US_NET_PRC_AMT   ,
   DRVD.DV_BKGS_COMP_US_LST_PRC_AMT   ,
   DRVD.DV_BKGS_COMP_US_COST_AMT      ,
   DRVD.DV_BKGS_EXTENDED_QUANTITY     ,
   DRVD.BK_SCAA_SALES_REP_NUMBER      ,
   DRVD.BK_SCAN_SALES_REP_NUMBER      ,
   DRVD.SALES_COMMISSION_PERCENTAGE   ,
   DRVD.SALES_CHANNEL_CODE            ,
   DRVD.DV_COMP_US_STANDARD_PRICE_AMT ,
   (NFISMN_SYS.BK_FISCAL_MONTH_NUMBER_INT+NFISMN_SYS.BK_FISCAL_YEAR_NUMBER_INT * 100 ) AS DV_FISCAL_YEAR_MTH_NUMBER_INT,
   DRVD.REPORTED_SALES_ORDER_NUM_INT  ,
   CAST(BPDC.PROCESS_DATE AS DATE) AS PROCESS_DATE ,
   DRVD.AR_TRX_KEY    ,                
   DRVD.AR_TRX_LINE_KEY,               
   DRVD.PRODUCT_KEY     ,              
   DRVD.SALES_ORDER_KEY  ,             
   DRVD.DV_SALES_ORDER_LINE_KEY       ,
   DRVD.SHIP_TO_CUSTOMER_KEY          ,
   DRVD.SOLD_TO_CUSTOMER_KEY          ,
   DRVD.BILL_TO_CUSTOMER_KEY          ,
   DRVD.SALES_CREDIT_TYPE_CODE        ,
   USER,
   USER,
   CURRENT_TIMESTAMP(0),
   CURRENT_TIMESTAMP(0),
   DRVD.CONVERSION_RT   ,              
   DRVD.DV_TRANSACTION_NAME           ,
   DRVD.DEFAULT_SC_FLG                ,
   DRVD.SK_LINE_SEQ_ID_INT            ,
   DRVD.SCA_SOURCE_TYPE_CD            ,
   DRVD.DV_TRANSACTION_SOURCE_CD      ,
   DRVD.DV_TRANSACTION_KEY            ,
    DRVD.TRANSACTION_SEQUENCE_ID_INT AS OLD_TRANSACTION_SEQ_ID,
   'INSERT' AS EVENT_TYPE,
   DRVD.DV_TRX_AMT, 
   DRVD.DV_FUNC_AMT, 
   DRVD.DV_TRX_QTY ,
   COALESCE(WI_SMC.SALES_MOTION_CD,'UNKNOWN') AS SALES_MOTION_CD          
  ,WI.NEW_CONTRACT_START_DTM AS RU_SERVICE_CONTRACT_START_DTM 
  ,WI.NEW_CONTRACT_END_DTM AS RU_SERVICE_CONTRACT_END_DTM   
  ,WI.NEW_CONTRACT_DURATION AS DV_CONTRACT_DURATION          
  ,DRVD.DV_ANNUALIZED_FLG             
  ,DRVD.DV_ANNUALIZED_US_NET_AMT      
  ,DRVD.DV_MULTIYEAR_US_NET_AMT   
  ,DRVD.BOOKINGS_POLICY_CD  
    FROM $$FINLGLVWDB.N_DRVD_NCR_REV_TRX_FOR_BKG DRVD
   INNER JOIN $$STGDB.WI_CONTRACT_CHANGE_RT_FWD WI
    ON  DRVD.DRVD_NCR_REV_TRX_BKG_KEY = WI.DRVD_NCR_REV_TRX_BKG_KEY
   LEFT OUTER JOIN $$STGDB.WI_AR_SALES_MOTION_CHANGE WI_SMC 
   ON DRVD.DV_SALES_ORDER_LINE_KEY=WI_SMC.SALES_ORDER_LINE_KEY
   INNER JOIN (SELECT PROCESS_DATE FROM $$ETLVWDB.BKG_PROCESS_DT_CNTRL) BPDC
    ON 1=1
  INNER JOIN  
 ( SELECT BK_FISCAL_MONTH_NUMBER_INT, BK_FISCAL_YEAR_NUMBER_INT
    FROM $$COMREFVWDB.N_FISCAL_MONTH 
   WHERE CURRENT_DATE-1 BETWEEN FISCAL_MONTH_START_DATE AND FISCAL_MONTH_END_DATE 
 ) NFISMN_SYS ON 1=1


Post SQL : 



Target7 Name : WI_RTE_NET_CHANGE_FOR_BKG7


Pre SQL : 



Post SQL : 
COLLECT STATS ON $$STGDB.WI_RTE_NET_CHANGE_FOR_BKG;                             

 UPDATE EL 
 FROM $$ETLVWDB.CTL_ETL_LAST_EXTRACT_DATES EL, 
   ( SELECT MAX(EDW_UPDATE_DATETIME) MAX_UPD_DATE FROM $$SLSORDVWDB.N_SALES_ORDER_LINE_TV WHERE END_TV_DATETIME = '3500-01-01 00:00:00') WI 
  SET LAST_EXTRACT_DATE = COALESCE(WI.MAX_UPD_DATE , EL.LAST_EXTRACT_DATE ) 
 WHERE JOB_STREAM_ID = 'wf_WI_RTE_NET_CHANGE_FOR_BKG'  
 AND TABLE_NAME = 'N_SALES_ORDER_LINE_TV';                              
 
 UPDATE EL 
 FROM $$ETLVWDB.CTL_ETL_LAST_EXTRACT_DATES EL, 
   ( SELECT MAX(EDW_UPDATE_DTM) MAX_UPD_DATE FROM $$SLSORDVWDB.N_SALES_ORDER_LINE_V1_TV WHERE END_TV_DTM = '3500-01-01 00:00:00') WI 
  SET LAST_EXTRACT_DATE = COALESCE(WI.MAX_UPD_DATE , EL.LAST_EXTRACT_DATE ) 
 WHERE JOB_STREAM_ID = 'wf_WI_RTE_NET_CHANGE_FOR_BKG'  
 AND TABLE_NAME = 'N_SALES_ORDER_LINE_V1_TV';