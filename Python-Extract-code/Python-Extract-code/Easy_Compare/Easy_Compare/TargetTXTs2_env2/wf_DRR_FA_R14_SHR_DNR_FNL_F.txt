ETL Name:	wf_DRR_FA_R14_SHR_DNR_FNL_F.xml


Session 1: 	s_m_DRR_FA_R14_SHR_DNR_FNL_F
Mapping 1: 	m_DRR_FA_R14_SHR_DNR_FNL_Fm_DRR_FA_R14_SHR_DNR_FNL_F


Source1 Name : SQ_N_DYN_RESTMT_SLS_ADJSTMT


Pre SQL : 



SQL Query : 
SELECT 
DYN_RESTMT_SLS_ADJSTMT_KEY    
,ORIGINAL_SALES_TERR_KEY       
,RESTATED_SALES_TERR_KEY       
,SALES_ORDER_LINE_KEY          
,BK_BOOKINGS_TRX_TYPE_CD       
,BK_ALLOCATION_SPLIT_PCT       
,BK_EFFECTIVE_DT               
,SK_TRX_ID_BIGINT              
,RESTATEMENT_SUB_TYPE_CD       
,CUST_PRTY_KEY                 
,DO_NOT_RESTATE_FLG            
,EXPIRATION_DT                 
,APPRVD_BY_CSCO_WRKR_PRTY_KEY  
,UPLOADED_BY_CSCO_WRKR_PRTY_KEY
,APPROVED_DTM                  
,DV_APPROVED_DT                
,UPLOADED_DTM                  
,DV_UPLOADED_DT                
,VALIDATION_STATUS_CD          
,VALIDATION_STATUS_REASON_DESCR
,UPLOAD_FILE_NAME              
,PROCESSED_FLG                 
,AR_TRX_LINE_KEY               
,BK_POS_TRX_ID_INT             
,BK_SALES_ADJ_LINE_NUM_INT     
,SO_SUBSCR_ITEM_SALES_TRX_KEY  
,REV_TRANSFER_KEY              
,SALES_ACCT_GRP_PRTY_KEY       
,EDW_CREATE_DTM                
,EDW_CREATE_USER               
,EDW_UPDATE_DTM                
,EDW_UPDATE_USER               
FROM 
$$SLSORDVWDB.N_DYN_RESTMT_SLS_ADJSTMT FIN_ADJ,
$$ETLVWDB.WI_DRR_PROCESS_CONTROL CTRL
WHERE 
CTRL.PROCESS_DATE BETWEEN BK_EFFECTIVE_DT AND EXPIRATION_DT
AND CTRL.ACTIVE_FLAG = 'Y'
AND ( RESTATEMENT_SUB_TYPE_CD LIKE 'RULE1%' OR RESTATEMENT_SUB_TYPE_CD LIKE 'RULE4%')


Post SQL : 



Target1 Name : WI_FIN_ADJ_BOOKINGS_ACTIVE_R141


Pre SQL : 
DELETE FROM $$STGDB.WI_FIN_ADJ_BOOKINGS_ACTIVE_R14 ALL;


Post SQL : 
CALL COLLECT_STATS_WRAP('$$STGDB','WI_FIN_ADJ_BOOKINGS_ACTIVE_R14','D');


Source2 Name : SQ_WI_FIN_ADJ_BOOKINGS_ACTIVE_R14


Pre SQL : 



SQL Query : 
SELECT 
  NBM.BOOKINGS_MEASURE_KEY ,         
  NBM.BOOKINGS_PROCESS_DATE ,        
  NBM.BKGS_MEASURE_TRANS_TYPE_CODE ,
  FIN_ADJ.ORIGINAL_SALES_TERR_KEY     ,   
  FIN_ADJ.RESTATED_SALES_TERR_KEY,
  FIN_ADJ.RESTATEMENT_SUB_TYPE_CD,
  'FinAdj' AS PROCESS_TYPE,   
  FIN_ADJ.DYN_RESTMT_SLS_ADJSTMT_KEY    ,
  FIN_ADJ.BK_ALLOCATION_SPLIT_PCT,
  NBM.SALES_REP_NUMBER AS SALES_REP_NUM
  
FROM 
 $$STGDB.WI_FIN_ADJ_BOOKINGS_ACTIVE_R14 FIN_ADJ
 CROSS JOIN ( SEL * FROM $$ETLVWDB.WI_DRR_PROCESS_CONTROL WHERE ACTIVE_FLAG = 'Y' ) CTRL
 INNER JOIN $$SLSORDVWDB.N_BOOKINGS_MEASURE NBM
  ON FIN_ADJ.SALES_ORDER_LINE_KEY = NBM.DV_SALES_ORDER_LINE_KEY
  AND FIN_ADJ.ORIGINAL_SALES_TERR_KEY = NBM.SALES_TERRITORY_KEY
  AND NBM.BKGS_MEASURE_TRANS_TYPE_CODE = 'ERP'
 INNER JOIN $$COMREFVWDB.R_FISCAL_DAY_TO_YEAR FDY
  ON NBM.BOOKINGS_PROCESS_DATE = FDY.CALENDAR_DATE
 WHERE FDY.FISCAL_YEAR_AGE <= CTRL.YEAR_FLG_INT
  
UNION

SELECT 
 NBM.BOOKINGS_MEASURE_KEY ,         
 NBM.BOOKINGS_PROCESS_DATE ,        
 NBM.BKGS_MEASURE_TRANS_TYPE_CODE ,
 FIN_ADJ.ORIGINAL_SALES_TERR_KEY     ,   
 FIN_ADJ.RESTATED_SALES_TERR_KEY,
 FIN_ADJ.RESTATEMENT_SUB_TYPE_CD,
 'FinAdj' AS PROCESS_TYPE,    
 FIN_ADJ.DYN_RESTMT_SLS_ADJSTMT_KEY       ,
 FIN_ADJ.BK_ALLOCATION_SPLIT_PCT ,
 NBM.SALES_REP_NUMBER AS SALES_REP_NUM
FROM 
 $$STGDB.WI_FIN_ADJ_BOOKINGS_ACTIVE_R14 FIN_ADJ
 CROSS JOIN ( SEL * FROM $$ETLVWDB.WI_DRR_PROCESS_CONTROL WHERE ACTIVE_FLAG = 'Y' ) CTRL
 INNER JOIN $$SLSORDVWDB.N_BOOKINGS_MEASURE NBM
  ON FIN_ADJ.AR_TRX_LINE_KEY = NBM.DV_AR_TRX_LINE_KEY
  AND FIN_ADJ.ORIGINAL_SALES_TERR_KEY = NBM.SALES_TERRITORY_KEY
  AND NBM.BKGS_MEASURE_TRANS_TYPE_CODE = 'AR'
  AND NBM.REVENUE_TRANSFER_KEY < 0
 INNER JOIN $$COMREFVWDB.R_FISCAL_DAY_TO_YEAR FDY
  ON NBM.BOOKINGS_PROCESS_DATE = FDY.CALENDAR_DATE
 WHERE FDY.FISCAL_YEAR_AGE <= CTRL.YEAR_FLG_INT
  
UNION

SELECT 
 NBM.BOOKINGS_MEASURE_KEY ,         
 NBM.BOOKINGS_PROCESS_DATE ,        
 NBM.BKGS_MEASURE_TRANS_TYPE_CODE ,
 FIN_ADJ.ORIGINAL_SALES_TERR_KEY     ,   
 FIN_ADJ.RESTATED_SALES_TERR_KEY,
 FIN_ADJ.RESTATEMENT_SUB_TYPE_CD,
 'FinAdj' AS PROCESS_TYPE,   
 FIN_ADJ.DYN_RESTMT_SLS_ADJSTMT_KEY    ,
 FIN_ADJ.BK_ALLOCATION_SPLIT_PCT,
 NBM.SALES_REP_NUMBER AS SALES_REP_NUM
FROM $$STGDB.WI_FIN_ADJ_BOOKINGS_ACTIVE_R14 FIN_ADJ
 CROSS JOIN ( SEL * FROM $$ETLVWDB.WI_DRR_PROCESS_CONTROL WHERE ACTIVE_FLAG = 'Y' ) CTRL
 INNER JOIN $$SLSORDVWDB.N_BOOKINGS_MEASURE NBM
  ON FIN_ADJ.REV_TRANSFER_KEY = NBM.REVENUE_TRANSFER_KEY
  AND FIN_ADJ.ORIGINAL_SALES_TERR_KEY = NBM.SALES_TERRITORY_KEY
 AND NBM.REVENUE_TRANSFER_KEY > 0
  AND NBM.BKGS_MEASURE_TRANS_TYPE_CODE = 'AR'
 INNER JOIN $$COMREFVWDB.R_FISCAL_DAY_TO_YEAR FDY
  ON NBM.BOOKINGS_PROCESS_DATE = FDY.CALENDAR_DATE
 WHERE FDY.FISCAL_YEAR_AGE <= CTRL.YEAR_FLG_INT
  
UNION
  
SELECT 
 NBM.BOOKINGS_MEASURE_KEY ,         
 NBM.BOOKINGS_PROCESS_DATE ,        
 NBM.BKGS_MEASURE_TRANS_TYPE_CODE ,
 FIN_ADJ.ORIGINAL_SALES_TERR_KEY     ,   
 FIN_ADJ.RESTATED_SALES_TERR_KEY,
 FIN_ADJ.RESTATEMENT_SUB_TYPE_CD,
 'FinAdj' AS PROCESS_TYPE,   
 FIN_ADJ.DYN_RESTMT_SLS_ADJSTMT_KEY    ,
 FIN_ADJ.BK_ALLOCATION_SPLIT_PCT,
 NBM.SALES_REP_NUMBER AS SALES_REP_NUM
FROM $$STGDB.WI_FIN_ADJ_BOOKINGS_ACTIVE_R14 FIN_ADJ
 CROSS JOIN ( SEL * FROM $$ETLVWDB.WI_DRR_PROCESS_CONTROL WHERE ACTIVE_FLAG = 'Y' ) CTRL
 INNER JOIN $$SLSORDVWDB.N_BOOKINGS_MEASURE NBM
  ON FIN_ADJ.BK_POS_TRX_ID_INT = NBM.BK_POS_TRANSACTION_ID_INT
  AND FIN_ADJ.ORIGINAL_SALES_TERR_KEY = NBM.SALES_TERRITORY_KEY
  AND NBM.BKGS_MEASURE_TRANS_TYPE_CODE = 'POS'
 INNER JOIN $$COMREFVWDB.R_FISCAL_DAY_TO_YEAR FDY
  ON NBM.BOOKINGS_PROCESS_DATE = FDY.CALENDAR_DATE
 WHERE FDY.FISCAL_YEAR_AGE <= CTRL.YEAR_FLG_INT
  
UNION
  
SELECT 
  NBM.BOOKINGS_MEASURE_KEY ,         
  NBM.BOOKINGS_PROCESS_DATE ,        
  NBM.BKGS_MEASURE_TRANS_TYPE_CODE ,
  FIN_ADJ.ORIGINAL_SALES_TERR_KEY     ,   
  FIN_ADJ.RESTATED_SALES_TERR_KEY,
  FIN_ADJ.RESTATEMENT_SUB_TYPE_CD,
  'FinAdj' AS PROCESS_TYPE,   
  FIN_ADJ.DYN_RESTMT_SLS_ADJSTMT_KEY    ,
  FIN_ADJ.BK_ALLOCATION_SPLIT_PCT,
  NBM.SALES_REP_NUMBER AS SALES_REP_NUM
FROM $$STGDB.WI_FIN_ADJ_BOOKINGS_ACTIVE_R14 FIN_ADJ
 CROSS JOIN ( SEL * FROM $$ETLVWDB.WI_DRR_PROCESS_CONTROL WHERE ACTIVE_FLAG = 'Y' ) CTRL
 INNER JOIN $$SLSORDVWDB.N_BOOKINGS_MEASURE NBM
  ON FIN_ADJ.BK_SALES_ADJ_LINE_NUM_INT = NBM.BK_SALES_ADJ_LINE_NUMBER_INT
  AND FIN_ADJ.ORIGINAL_SALES_TERR_KEY = NBM.SALES_TERRITORY_KEY
  AND NBM.BKGS_MEASURE_TRANS_TYPE_CODE = 'SLS_ADJ'
 INNER JOIN $$COMREFVWDB.R_FISCAL_DAY_TO_YEAR FDY
  ON NBM.BOOKINGS_PROCESS_DATE = FDY.CALENDAR_DATE
 WHERE FDY.FISCAL_YEAR_AGE <= CTRL.YEAR_FLG_INT
  
UNION
  
SELECT 
 NBM.BOOKINGS_MEASURE_KEY ,         
 NBM.BOOKINGS_PROCESS_DATE ,        
 NBM.BKGS_MEASURE_TRANS_TYPE_CODE ,
 FIN_ADJ.ORIGINAL_SALES_TERR_KEY     ,   
 FIN_ADJ.RESTATED_SALES_TERR_KEY,
 FIN_ADJ.RESTATEMENT_SUB_TYPE_CD,
 'FinAdj' AS PROCESS_TYPE,   
 FIN_ADJ.DYN_RESTMT_SLS_ADJSTMT_KEY,
 FIN_ADJ.BK_ALLOCATION_SPLIT_PCT ,
 NBM.SALES_REP_NUMBER AS SALES_REP_NUM
FROM $$STGDB.WI_FIN_ADJ_BOOKINGS_ACTIVE_R14 FIN_ADJ
 CROSS JOIN ( SEL * FROM $$ETLVWDB.WI_DRR_PROCESS_CONTROL WHERE ACTIVE_FLAG = 'Y' ) CTRL
 INNER JOIN $$SLSORDVWDB.N_BOOKINGS_MEASURE NBM
  ON FIN_ADJ.SO_SUBSCR_ITEM_SALES_TRX_KEY = NBM.DV_SO_SBSCRPTN_ITM_SLS_TRX_KEY
  AND FIN_ADJ.ORIGINAL_SALES_TERR_KEY = NBM.SALES_TERRITORY_KEY
  AND NBM.BKGS_MEASURE_TRANS_TYPE_CODE = 'XAAS'
 INNER JOIN $$COMREFVWDB.R_FISCAL_DAY_TO_YEAR FDY
  ON NBM.BOOKINGS_PROCESS_DATE = FDY.CALENDAR_DATE
 WHERE FDY.FISCAL_YEAR_AGE <= CTRL.YEAR_FLG_INT


Post SQL : 



Target2 Name : WI_FIN_ADJ_BOOKINGS_R14_ALL1


Pre SQL : 
DELETE FROM $$STGDB.WI_FIN_ADJ_BOOKINGS_R14_ALL ALL;


Post SQL : 
CALL COLLECT_STATS_WRAP('$$STGDB','WI_FIN_ADJ_BOOKINGS_R14_ALL','D');


Source3 Name : SQ_WI_FIN_ADJ_BOOKINGS_R14_ALL


Pre SQL : 



SQL Query : 
SELECT
R14.BOOKINGS_MEASURE_KEY AS BOOKINGS_MEASURE_KEY,
R14.BOOKINGS_PROCESS_DATE AS BOOKINGS_PROCESS_DATE,
R14.BKGS_MEASURE_TRANS_TYPE_CODE AS BKGS_MEASURE_TRANS_TYPE_CODE,
MT.DV_END_CUST_PARTY_KEY AS DV_END_CUST_PARTY_KEY,
-999 AS NEW_SA_MEMBER_ID_INT,
-999 AS LINK_CUSTOMER_PARTY_KEY,
-999 AS SALES_ACCOUNT_GROUP_PARTY_KEY ,
MT.DV_END_CUST_REASON_DESCR AS REASON_DESC_END_CUST,
CASE 
 WHEN R14.RESTATEMENT_SUB_TYPE_CD LIKE 'RULE1%' THEN '18 - FINANCE ADJUSTMENT NODE'
 ELSE '19 - FINANCE ADJUSTMENT DNR'
END REASON_DESCR,
R14.BK_ALLOCATION_SPLIT_PCT AS SALES_CREDIT_SPLIT_PCT,
CASE 
 WHEN R14.RESTATEMENT_SUB_TYPE_CD LIKE 'RULE1%' THEN R14.RESTATED_SALES_TERR_KEY
 ELSE R14.ORIGINAL_SALES_TERR_KEY 
END SLS_ACCT_GROUP_SALES_TERR_KEY ,
CASE 
	WHEN R14.RESTATEMENT_SUB_TYPE_CD LIKE 'RULE4%' THEN R14.SALES_REP_NUM
		ELSE -999 
END SALES_REP_NUM,
-999 EP_OTM_TERRITORY_ID_INT,
R14.DYN_RESTMT_SLS_ADJSTMT_KEY AS FIN_ADJ_KEY, 
R14.PROCESS_TYPE AS PROCESS_TYPE   
FROM 
$$STGDB.WI_FIN_ADJ_BOOKINGS_R14_ALL R14
INNER JOIN (
SELECT 
 BOOKINGS_MEASURE_KEY,
 BOOKINGS_PROCESS_DT,
 BKGS_MEASURE_TRANS_TYPE_CD,
 DV_END_CUST_PARTY_KEY         ,
 DV_END_CUST_REASON_DESCR      
 FROM $$SLSORDVWDB.MT_SLS_ACNT_RSTD_MSR_DRR_NG NG
 QUALIFY ROW_NUMBER() OVER(PARTITION BY BOOKINGS_MEASURE_KEY,BOOKINGS_PROCESS_DT,BKGS_MEASURE_TRANS_TYPE_CD ORDER BY DV_END_CUST_OWNERSHIP_SPLT_PCT DESC ) = 1
 ) MT
 ON R14.BOOKINGS_MEASURE_KEY = MT.BOOKINGS_MEASURE_KEY
 AND R14.BOOKINGS_PROCESS_DATE = MT.BOOKINGS_PROCESS_DT
 AND R14.BKGS_MEASURE_TRANS_TYPE_CODE = MT.BKGS_MEASURE_TRANS_TYPE_CD


Post SQL : 



Target3 Name : WI_DRR_FA_R14_SHR_DNR_FNL_F


Pre SQL : 
DELETE FROM $$STGDB.WI_DRR_FA_R14_SHR_DNR_FNL_F ALL;


Post SQL : 
CALL COLLECT_STATS_WRAP('$$STGDB','WI_DRR_FA_R14_SHR_DNR_FNL_F','D');


Source4 Name : SQ_R_SALES_HIERARCHY


Pre SQL : 
CALL COLLECT_STATS_WRAP('$$SLSORDVWDB','N_BOOKINGS_MEASURE','D');
CALL COLLECT_STATS_WRAP('$$COMREFVWDB','R_SALES_HIERARCHY','D');


SQL Query : 
SELECT
 NBM.BOOKINGS_MEASURE_KEY AS BOOKINGS_MEASURE_KEY          ,
 NBM.BOOKINGS_PROCESS_DATE AS BOOKINGS_PROCESS_DATE         ,
 NBM.BKGS_MEASURE_TRANS_TYPE_CODE AS BKGS_MEASURE_TRANS_TYPE_CODE  ,
 MT.DV_END_CUST_PARTY_KEY AS DV_END_CUST_PARTY_KEY,
 -999 AS NEW_SA_MEMBER_ID_INT          ,
 -999 AS LINK_CUSTOMER_PARTY_KEY       ,
 -999 AS SALES_ACCOUNT_GROUP_PARTY_KEY ,
 MT.DV_END_CUST_REASON_DESCR AS REASON_DESC_END_CUST,
 CASE WHEN EL.ACTIVE_SALES_TERRITORY_KEY IS NOT NULL THEN '20- SHARE DNR_REPLACED WITH ACTIVE NODE' 
	     ELSE '20- SHARE DNR'
     END AS REASON_DESCR,
 100 AS SALES_CREDIT_SPLIT_PCT        ,
 CASE WHEN EL.ACTIVE_SALES_TERRITORY_KEY IS NOT NULL THEN EL.ACTIVE_SALES_TERRITORY_KEY
    ELSE NBM.SALES_TERRITORY_KEY 
  END AS SLS_ACCT_GROUP_SALES_TERR_KEY ,
 CASE WHEN EL.ACTIVE_SALES_TERRITORY_KEY IS NOT NULL  THEN -999
	ELSE NBM.SALES_REP_NUMBER 
	END AS SALES_REP_NUM                 ,
 -999 EP_OTM_TERRITORY_ID_INT       ,
 -999 FIN_ADJ_KEY   ,                
 'FinAdj' AS PROCESS_TYPE 
FROM
( SELECT * FROM $$COMREFVWDB.R_SALES_HIERARCHY WHERE DO_NOT_RESTATE_FLG = 'Y') RSH
CROSS JOIN ( SELECT * FROM $$ETLVWDB.WI_DRR_PROCESS_CONTROL WHERE ACTIVE_FLAG = 'Y') CTRL
INNER JOIN $$SLSORDVWDB.N_BOOKINGS_MEASURE NBM
ON NBM.SALES_TERRITORY_KEY = RSH.SALES_TERRITORY_KEY
INNER JOIN $$COMREFVWDB.R_FISCAL_DAY_TO_YEAR FDY
ON NBM.BOOKINGS_PROCESS_DATE = FDY.CALENDAR_DATE
INNER JOIN ( SELECT 
     BOOKINGS_MEASURE_KEY,
     BOOKINGS_PROCESS_DT,
     BKGS_MEASURE_TRANS_TYPE_CD,
     DV_END_CUST_PARTY_KEY         ,
     DV_END_CUST_REASON_DESCR      
     FROM $$SLSORDVWDB.MT_SLS_ACNT_RSTD_MSR_DRR_NG NG
     QUALIFY ROW_NUMBER() OVER(PARTITION BY BOOKINGS_MEASURE_KEY,BOOKINGS_PROCESS_DT,BKGS_MEASURE_TRANS_TYPE_CD ORDER BY DV_END_CUST_OWNERSHIP_SPLT_PCT DESC ) = 1 
	) MT
 ON NBM.BOOKINGS_MEASURE_KEY = MT.BOOKINGS_MEASURE_KEY
 AND NBM.BOOKINGS_PROCESS_DATE = MT.BOOKINGS_PROCESS_DT
 AND NBM.BKGS_MEASURE_TRANS_TYPE_CODE = MT.BKGS_MEASURE_TRANS_TYPE_CD
LEFT JOIN ( SELECT * FROM $$ETLVWDB.EL_ACT_INACT_NODE_MAP_DRR WHERE VALID_FLAG = 'Y' ) EL
 ON NBM.SALES_TERRITORY_KEY = EL.OLD_SALES_TERRITORY_KEY
WHERE FDY.FISCAL_YEAR_AGE <= CTRL.YEAR_FLG_INT
AND NOT EXISTS ( SELECT 1 FROM 
 $$STGDB.WI_DRR_FA_R14_SHR_DNR_FNL_F FNL_F
 WHERE FNL_F.BOOKINGS_MEASURE_KEY  = NBM.BOOKINGS_MEASURE_KEY
 AND FNL_F.BOOKINGS_PROCESS_DATE = NBM.BOOKINGS_PROCESS_DATE
 AND FNL_F.BKGS_MEASURE_TRANS_TYPE_CODE = NBM.BKGS_MEASURE_TRANS_TYPE_CODE )


Post SQL : 



Target4 Name : WI_DRR_FA_R14_SHR_DNR_FNL_F1


Pre SQL : 



Post SQL : 
CALL COLLECT_STATS_WRAP('$$STGDB','WI_DRR_FA_R14_SHR_DNR_FNL_F','D');