ETL Name:	wf_N_DYN_RESTMT_SLS_ADJSTMT.xml


Session 1: 	s_m_N_DYN_RESTMT_SLS_ADJSTMT
Mapping 1: 	m_N_DYN_RESTMT_SLS_ADJSTMTm_N_DYN_RESTMT_SLS_ADJSTMT


Source1 Name : SQ_W_DYN_RESTMT_SLS_ADJSTMT


Pre SQL : 



SQL Query : 
SELECT
	 DYN_RESTMT_SLS_ADJSTMT_KEY    
	,ORIGINAL_SALES_TERR_KEY       
	,RESTATED_SALES_TERR_KEY       
	,SALES_ORDER_LINE_KEY          
	,BK_BOOKINGS_TRX_TYPE_CD       
	,BK_ALLOCATION_SPLIT_PCT       
	,BK_EFFECTIVE_DT               
	,SK_TRX_ID_BIGINT              
	,RESTATEMENT_SUB_TYPE_CD       
	,CUST_PRTY_KEY                 
	,DO_NOT_RESTATE_FLG            
	,EXPIRATION_DT                 
	,APPRVD_BY_CSCO_WRKR_PRTY_KEY  
	,UPLOADED_BY_CSCO_WRKR_PRTY_KEY
	,APPROVED_DTM                  
	,DV_APPROVED_DT                
	,UPLOADED_DTM                  
	,DV_UPLOADED_DT                
	,VALIDATION_STATUS_CD          
	,VALIDATION_STATUS_REASON_DESCR
	,UPLOAD_FILE_NAME              
	,PROCESSED_FLG                 
	,AR_TRX_LINE_KEY               
	,BK_POS_TRX_ID_INT             
	,BK_SALES_ADJ_LINE_NUM_INT     
	,SO_SUBSCR_ITEM_SALES_TRX_KEY  
	,REV_TRANSFER_KEY              
	,SALES_ACCT_GRP_PRTY_KEY       
	,DV_BOOKINGS_TRX_REF_ID
	,CURRENT_TIMESTAMP(0) EDW_CREATE_DTM,
	USER EDW_CREATE_USER,
	CURRENT_TIMESTAMP(0) EDW_UPDATE_DTM,
	USER EDW_UPDATE_USER,
	REASON_COMMENT_TXT
FROM
	$$WORKDB.W_DYN_RESTMT_SLS_ADJSTMT WD
WHERE DML_TYPE='I'
  AND NOT EXISTS ( SELECT 1 FROM $$SLSORDVWDB.N_DYN_RESTMT_SLS_ADJSTMT ND 
                   WHERE WD.BK_BOOKINGS_TRX_TYPE_CD = ND.BK_BOOKINGS_TRX_TYPE_CD
				     AND WD.SALES_ORDER_LINE_KEY = ND.SALES_ORDER_LINE_KEY 
				     AND WD.AR_TRX_LINE_KEY = ND.AR_TRX_LINE_KEY 
				     AND WD.BK_POS_TRX_ID_INT = ND.BK_POS_TRX_ID_INT
				     AND WD.BK_SALES_ADJ_LINE_NUM_INT = ND.BK_SALES_ADJ_LINE_NUM_INT
				     AND WD.SO_SUBSCR_ITEM_SALES_TRX_KEY = ND.SO_SUBSCR_ITEM_SALES_TRX_KEY  
				     AND WD.REV_TRANSFER_KEY = ND.REV_TRANSFER_KEY              
				     AND WD.ORIGINAL_SALES_TERR_KEY = ND.ORIGINAL_SALES_TERR_KEY
				     AND WD.RESTATEMENT_SUB_TYPE_CD = ND.RESTATEMENT_SUB_TYPE_CD
				     AND WD.BK_EFFECTIVE_DT = ND.BK_EFFECTIVE_DT 
				  )


Post SQL : 



Target1 Name : N_DYN_RESTMT_SLS_ADJSTMT


Pre SQL : 



Post SQL : 
UPDATE NDRSAU 
FROM $$SLSORDVWDB.N_DYN_RESTMT_SLS_ADJSTMT NDRSAU,
	 $$WORKDB.W_DYN_RESTMT_SLS_ADJSTMT WDRSAU
SET
	 EXPIRATION_DT = WDRSAU.EXPIRATION_DT
	,EDW_UPDATE_DTM = CURRENT_TIMESTAMP(0)
	,EDW_UPDATE_USER = USER
WHERE WDRSAU.DYN_RESTMT_SLS_ADJSTMT_KEY = NDRSAU.DYN_RESTMT_SLS_ADJSTMT_KEY
  AND WDRSAU.DML_TYPE = 'U';

UPDATE ND
  FROM $$SLSORDVWDB.N_DYN_RESTMT_SLS_ADJSTMT ND ,
               ( SELECT * FROM $$WORKDB.W_DYN_RESTMT_SLS_ADJSTMT
                   WHERE DML_TYPE = 'I'
                   QUALIFY ROW_NUMBER() OVER (
                           PARTITION BY 
                                     BK_BOOKINGS_TRX_TYPE_CD
                                    ,SALES_ORDER_LINE_KEY
                                    ,AR_TRX_LINE_KEY
                                    ,BK_POS_TRX_ID_INT
                                    ,BK_SALES_ADJ_LINE_NUM_INT
                                    ,SO_SUBSCR_ITEM_SALES_TRX_KEY
                                    ,REV_TRANSFER_KEY
                                    ,ORIGINAL_SALES_TERR_KEY
                                    ,RESTATEMENT_SUB_TYPE_CD
                                    ,BK_EFFECTIVE_DT
                                    ,SALES_ACCT_GRP_PRTY_KEY
                                    ,RESTATED_SALES_TERR_KEY 
                         ORDER BY BK_EFFECTIVE_DT ) = 1       
                 ) WD    
  SET EXPIRATION_DT = WD.EXPIRATION_DT
          ,APPRVD_BY_CSCO_WRKR_PRTY_KEY = WD.APPRVD_BY_CSCO_WRKR_PRTY_KEY
          ,UPLOADED_BY_CSCO_WRKR_PRTY_KEY = WD.UPLOADED_BY_CSCO_WRKR_PRTY_KEY
          ,APPROVED_DTM = WD.APPROVED_DTM
          ,DV_APPROVED_DT = WD.DV_APPROVED_DT
          ,UPLOADED_DTM = WD.UPLOADED_DTM
          ,DV_UPLOADED_DT = WD.DV_UPLOADED_DT
          ,UPLOAD_FILE_NAME = WD.UPLOAD_FILE_NAME
          ,EDW_UPDATE_DTM = WD.EDW_UPDATE_DTM
          ,EDW_UPDATE_USER = WD.EDW_UPDATE_USER 
WHERE DML_TYPE = 'I'
  AND WD.BK_BOOKINGS_TRX_TYPE_CD = ND.BK_BOOKINGS_TRX_TYPE_CD
  AND WD.SALES_ORDER_LINE_KEY = ND.SALES_ORDER_LINE_KEY
  AND WD.AR_TRX_LINE_KEY = ND.AR_TRX_LINE_KEY
  AND WD.BK_POS_TRX_ID_INT = ND.BK_POS_TRX_ID_INT
  AND WD.BK_SALES_ADJ_LINE_NUM_INT = ND.BK_SALES_ADJ_LINE_NUM_INT
  AND WD.SO_SUBSCR_ITEM_SALES_TRX_KEY = ND.SO_SUBSCR_ITEM_SALES_TRX_KEY 
  AND WD.REV_TRANSFER_KEY = ND.REV_TRANSFER_KEY             
  AND WD.ORIGINAL_SALES_TERR_KEY = ND.ORIGINAL_SALES_TERR_KEY
  AND WD.RESTATEMENT_SUB_TYPE_CD = ND.RESTATEMENT_SUB_TYPE_CD
  AND WD.BK_EFFECTIVE_DT = ND.BK_EFFECTIVE_DT
  AND WD.SALES_ACCT_GRP_PRTY_KEY = ND.SALES_ACCT_GRP_PRTY_KEY      
  AND WD.RESTATED_SALES_TERR_KEY = ND.RESTATED_SALES_TERR_KEY ; 
  
  
 UPDATE DJS FROM
    $$ETLVWDB.DW_JOB_STREAMS DJS,
    (SELECT COALESCE(MAX(EDW_UPDATE_DTM), CAST('1900-01-01 00:00:00' AS TIMESTAMP(0))) AS MAX_UPD FROM $$SLSORDVWDB.N_DYN_RESTMT_SLS_ADJ_UPLD) N_UPLD
 SET LAST_EXTRACT_DATE=N_UPLD.MAX_UPD
 WHERE DJS.JOB_STREAM_ID = 'wf_W_DYN_RESTMT_SLS_ADJUSTMENT' ;