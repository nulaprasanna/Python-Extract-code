ETL Name:	wf_WI_FIN_ADJ_DRR_NG_1.xml


Session 1: 	s_m_WI_FIN_ADJ_DRR_NG_1
Mapping 1: 	m_WI_FIN_ADJ_DRR_NG_1m_WI_FIN_ADJ_DRR_NG_1


Source1 Name : SQ_WI_FIN_ADJ_DRR_NG_1


Pre SQL : 
DELETE FROM $$STGDB.WI_FIN_ADJ_DRR_NG_1 ;


SQL Query : 
SELECT 
  RESTATEMENT_SUB_TYPE,
  BOOK_SOURCE,
  BOOK_SOURCE_SUB_TYPE ,
  ORDER_NUMBER, 
  ORDER_LINE_ID, 
  SALES_TERRITORY_NAME_CODE,
  RESTATED_SALES_TERR_NAME_CODE,
  PARTY_ID,
  SAV_ID,
  SPLIT,
  DNR_FLAG,
  EFFECTIVE_DATE,                
  EXPIRY_DATE ,                    
  APPROVED_BY,
  APPROVED_DTM,
  UPLOADED_BY,
  UPLOADED_DTM,
  FILE_NAME,
  REASON_DESCR,
  CASE WHEN OREPLACE(VALIDATION_COMMENTS,'') IS NULL THEN 'SUCCESS' ELSE 'FAILED' END AS STATUS,
  VALIDATION_COMMENTS ,
  TRX_ID_INT,
  ROW_NUMBER() OVER(ORDER BY BOOK_SOURCE ) + SK.MAX_FILE_NO AS FILE_NUM_INT  
FROM 
(
SELECT 
    WI.RESTATEMENT_SUB_TYPE,
    WI.BOOK_SOURCE,
    WI.BOOK_SOURCE_SUB_TYPE,
    WI.ORDER_NUMBER, 
    WI.ORDER_LINE_ID, 
    WI.TRX_ID_INT,
    WI.SALES_TERRITORY_NAME_CODE,
    WI.RESTATED_SALES_TERR_NAME_CODE,
    WI.PARTY_ID,
    WI.SAV_ID,
    WI.SPLIT,
    WI.DNR_FLAG,
    WI.EFFECTIVE_DATE,                
    WI.EXPIRY_DATE,                    
    WI.APPROVED_BY,
    WI.APPROVED_DTM,
    WI.UPLOADED_BY,
    WI.UPLOADED_DTM,
    WI.FILE_NAME,
    WI.REASON_DESCR,
    CASE WHEN RL.RESTATEMENT_SUB_TYPE IS NULL THEN 'INVALID_RESTATEMENT_SUB_TYPE' ELSE ',' END VALIDATION_1 ,
	CASE WHEN RL.RESTATEMENT_SUB_TYPE IS NOT NULL AND TRIM(WI.BOOK_SOURCE) <> RL.BOOK_SOURCE THEN 'INVALID BOOK SOURCE'
		 ELSE ',' 
	 END AS VALIDATION_2 ,		 
	CASE WHEN TRIM(WI.BOOK_SOURCE_SUB_TYPE) NOT IN ( 'ERP', 'AR', 'POS', 'SLS_ADJ', 'XAAS', 'RTE', 'DSV') THEN 'INVALID SOURCE SYSTEM' ELSE ',' END AS VALIDATION_3 ,
    CASE WHEN (NCWP_AB.CEC_ID IS NULL OR WI.APPROVED_BY IS NULL ) THEN  'INVALID_APPROVED_BY' ELSE ',' END AS VALIDATION_4 , 
    TRIM( BOTH ',' FROM REGEXP_REPLACE(VALIDATION_1||','||VALIDATION_2||','||VALIDATION_3||','||VALIDATION_4,'(,)+' , ',' ,1,0,'c' )) AS VALIDATION_COMMENTS 
 FROM $$STGDB.WI_FIN_ADJ_DRR WI 
 LEFT JOIN $$COMREFVWDB.N_CISCO_WORKER_PARTY NCWP_AB
    ON NCWP_AB.CEC_ID = WI.APPROVED_BY
    AND NCWP_AB.RU_EMPLOYEE_STATUS_CODE = 'A' 
 LEFT JOIN $$STGDB.WI_DRR_FIN_ADJ_RULE RL 
    ON RL.RESTATEMENT_SUB_TYPE = WI.RESTATEMENT_SUB_TYPE
 ) WI,
( SELECT COALESCE(MAX(BK_UPLOAD_FILE_LINE_NUM_INT),0) MAX_FILE_NO FROM $$SLSORDVWDB.N_DYN_RESTMT_SLS_ADJ_UPLD ) SK


Post SQL : 



Target1 Name : WI_FIN_ADJ_DRR_NG_1


Pre SQL : 



Post SQL : 
CALL COLLECT_STATS_WRAP('$$STGDB','WI_FIN_ADJ_DRR_NG_1','D');