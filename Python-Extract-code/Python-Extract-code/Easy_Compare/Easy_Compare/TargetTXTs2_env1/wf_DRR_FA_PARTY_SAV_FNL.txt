ETL Name:	wf_DRR_FA_PARTY_SAV_FNL.xml


Session 1: 	s_m_DRR_FA_PARTY_SAV_FNL
Mapping 1: 	m_DRR_FA_PARTY_SAV_FNLm_DRR_FA_PARTY_SAV_FNL


Source1 Name : SQ_WI_DRR_BOOKINGS_PARTY_ENRICH


Pre SQL : 



SQL Query : 
SELECT
  ENRICH.BOOKINGS_MEASURE_KEY    ,      
  ENRICH.BOOKINGS_PROCESS_DATE   ,      
  ENRICH.BKGS_MEASURE_TRANS_TYPE_CODE  ,
  ENRICH.DV_END_CUST_PARTY_KEY,
  COALESCE (SYS_VIEW.BK_SA_MEMBER_ID_INT,-999) AS NEW_SA_MEMBER_ID_INT,
  COALESCE(SYS_VIEW.LINK_CUSTOMER_PARTY_KEY, -999) AS LINK_CUSTOMER_PARTY_KEY ,
  ENRICH.SALES_ACCOUNT_GROUP_PARTY_KEY,
  ENRICH.REASON_DESC AS REASON_DESC_END_CUST,             
  CAST( '21 - FINANCE ADJUSTMENT SAV' AS VARCHAR(60)) AS REASON_DESCR,
  FIN_ADJ.BK_ALLOCATION_SPLIT_PCT,
  SYS_VIEW.SLS_ACCT_GROUP_SALES_TERR_KEY,
  SYS_VIEW.SALES_REP_NUM,
  -999 as EP_OTM_TERRITORY_ID_INT,
  SYS_VIEW.ISO_COUNTRY_CODE,
  ENRICH.FIN_ADJ_KEY,
  ENRICH.PROCESS_TYPE
 FROM 
 ( SELECT * FROM $$STGDB.WI_DRR_BOOKINGS_PARTY_ENRICH WHERE RULE_PROCESS_FLAG='N') ENRICH
 INNER JOIN $$STGDB.WI_FIN_ADJ_BOOKINGS_ALL FIN_ADJ
 ON FIN_ADJ.BOOKINGS_MEASURE_KEY = ENRICH.BOOKINGS_MEASURE_KEY
 AND FIN_ADJ.BOOKINGS_PROCESS_DATE = ENRICH.BOOKINGS_PROCESS_DATE
 AND FIN_ADJ.BKGS_MEASURE_TRANS_TYPE_CODE = ENRICH.BKGS_MEASURE_TRANS_TYPE_CODE
 AND FIN_ADJ.RESTATEMENT_SUB_TYPE_CD LIKE 'RULE3%'
 INNER JOIN $$STGDB.WI_DRR_SYSVIEW_PARTY SYS_VIEW
 ON SYS_VIEW.SALES_ACCOUNT_GROUP_PARTY_KEY = ENRICH.SALES_ACCOUNT_GROUP_PARTY_KEY
 AND SYS_VIEW.CUSTOMER_PARTY_KEY = ENRICH.DV_END_CUST_PARTY_KEY
 AND SYS_VIEW.SALES_ACCOUNT_GROUP_TYPE_CD = 'NAMED_ACCOUNT'
 QUALIFY ROW_NUMBER() OVER (PARTITION BY ENRICH.BOOKINGS_MEASURE_KEY,ENRICH.BOOKINGS_PROCESS_DATE,ENRICH.BKGS_MEASURE_TRANS_TYPE_CODE,NEW_SA_MEMBER_ID_INT 
 ORDER BY  REASON_DESC_END_CUST,DV_END_CUST_PARTY_KEY) = 1


Post SQL : 



Target1 Name : WI_DRR_FIN_ADJ_RULE3_PARTY_SAV1


Pre SQL : 
DELETE FROM $$STGDB.WI_DRR_FIN_ADJ_RULE3_PARTY_SAV ALL;


Post SQL : 
CALL COLLECT_STATS_WRAP('$$STGDB','WI_DRR_FIN_ADJ_RULE3_PARTY_SAV','D');


Source2 Name : SQ_WI_DRR_FIN_ADJ_RULE3_PARTY_SAV


Pre SQL : 



SQL Query : 
SELECT 
WI.BOOKINGS_MEASURE_KEY          ,
WI.BOOKINGS_PROCESS_DATE         ,
WI.BKGS_MEASURE_TRANS_TYPE_CODE  ,
WI.DV_END_CUST_PARTY_KEY         ,
WI.NEW_SA_MEMBER_ID_INT          ,
WI.LINK_CUSTOMER_PARTY_KEY      ,
WI.SALES_ACCOUNT_GROUP_PARTY_KEY ,
WI.REASON_DESC_END_CUST          ,
WI.REASON_DESCR                  ,
WI.BK_ALLOCATION_SPLIT_PCT AS SALES_CREDIT_SPLIT_PCT        ,
WI.SALES_TERRITORY_KEY AS SLS_ACCT_GROUP_SALES_TERR_KEY ,
WI.SALES_REP_NUMBER AS SALES_REP_NUM                 ,
WI.EP_OTM_TERRITORY_ID_INT AS EP_OTM_TERRITORY_ID_INT       ,
WI.FIN_ADJ_KEY AS FIN_ADJ_KEY                   ,
WI.PROCESS_TYPE AS PROCESS_TYPE
FROM
$$STGDB.WI_DRR_FIN_ADJ_RULE3_PARTY_SAV WI
WHERE (BOOKINGS_MEASURE_KEY, BKGS_MEASURE_TRANS_TYPE_CODE, BOOKINGS_PROCESS_DATE) IN 
(
SELECT BOOKINGS_MEASURE_KEY, BKGS_MEASURE_TRANS_TYPE_CODE, BOOKINGS_PROCESS_DATE
FROM $$STGDB.WI_DRR_FIN_ADJ_RULE3_PARTY_SAV GROUP BY 1,2,3 HAVING SUM(BK_ALLOCATION_SPLIT_PCT) = 100)


Post SQL : 



Target2 Name : WI_DRR_SALES_ACNT_MEASURE_FNL


Pre SQL : 
DELETE FROM $$STGDB.WI_DRR_SALES_ACNT_MEASURE_FNL ;


Post SQL : 
UPDATE ENRICH_RULE3 
FROM
$$STGDB.WI_DRR_BOOKINGS_PARTY_ENRICH ENRICH_RULE3,
(
 SELECT 
 BOOKINGS_MEASURE_KEY,
 BOOKINGS_PROCESS_DATE,
 BKGS_MEASURE_TRANS_TYPE_CODE
 FROM
 $$STGDB.WI_DRR_SALES_ACNT_MEASURE_FNL
 WHERE
 REASON_DESCR = '21 - FINANCE ADJUSTMENT SAV'
 GROUP BY 1,2,3
)FNL
SET 
RULE_PROCESS_FLAG='Y'
WHERE
ENRICH_RULE3.BOOKINGS_MEASURE_KEY=FNL.BOOKINGS_MEASURE_KEY
AND ENRICH_RULE3.BOOKINGS_PROCESS_DATE=FNL.BOOKINGS_PROCESS_DATE
AND ENRICH_RULE3.BKGS_MEASURE_TRANS_TYPE_CODE=FNL.BKGS_MEASURE_TRANS_TYPE_CODE;

CALL COLLECT_STATS_WRAP('$$STGDB','WI_DRR_SALES_ACNT_MEASURE_FNL','D');